##############################################################################
# Initialization
##############################################################################

- name: Set upgrade start time
  ansible.builtin.set_fact:
    upgrade_start_time: "{{ ansible_date_time.iso8601_basic_short }}"

##############################################################################
# Current Version Analysis
##############################################################################

- name: Check current dozzle container status
  ansible.builtin.include_tasks: check.yml
  
- name: Verify Dozzle container exists
  ansible.builtin.assert:
    that:
      - check_result is defined
      - check_result.services is defined
      - check_result.services | length > 0
    fail_msg: "No existing Dozzle container found for upgrade. Please deploy a new instance first."

- name: Extract current running dozzle image information
  ansible.builtin.set_fact:
    current_service: "{{ check_result.services | selectattr('service', 'equalto', 'dozzle') | first }}"
  when: check_result.services | selectattr('service', 'equalto', 'dozzle') | list | length > 0

- name: Verify dozzle service information is available
  ansible.builtin.assert:
    that:
      - current_service is defined
      - current_service.image is defined
    fail_msg: "Unable to find Dozzle service information in the check results."

- name: Extract current dozzle version using regex
  ansible.builtin.set_fact:
    current_image_match: "{{ current_service.image | regex_search('^\"?(?P<depName>[^\\s:@\"]+)(?::(?P<currentValue>[-a-zA-Z0-9.]+))?(?:@(?P<currentDigest>sha256:[a-zA-Z0-9]+))?\"?$') }}"
    current_image_tag: omit # Explicitly omit first
  when: current_service.image is defined

- name: Set image tag from regex match if found
  ansible.builtin.set_fact:
    current_image_name: "{{ current_image_match.depName }}"
    current_image_tag: "{{ current_image_match.currentValue }}"
  when:
    - current_image_match is defined
    - current_image_match.depName is defined
    - current_image_match.currentValue is defined and current_image_match.currentValue != 'latest'

- name: Check if current image tag is missing and fail
  when: current_image_tag == omit
  ansible.builtin.fail:
    msg: "ERROR: Cannot determine the current image tag for '{{ current_service.image }}'. Please ensure the running service uses an explicit, non-latest version tag (e.g., 'amir20/dozzle:v8.12.4') before attempting an upgrade. Upgrade aborted for this host."

##############################################################################
# Backup and Prepare for Upgrade
##############################################################################

- name: Define docker-compose paths
  ansible.builtin.set_fact:
    compose_file_path: "{{ service_project_src }}/docker-compose.yml"
    compose_backup_path: "{{ service_project_src }}/{{ upgrade_start_time }}_docker-compose.yml"

- name: Check if current docker-compose file exists
  ansible.builtin.stat:
    path: "{{ compose_file_path }}"
  register: compose_file_stat

- name: Backup current docker-compose file
  ansible.builtin.command:
    cmd: "mv {{ compose_file_path }} {{ compose_backup_path }}"
  when: compose_file_stat.stat.exists
  changed_when: true
  register: backup_result

##############################################################################
# Configuration Preservation and Template Management
##############################################################################

- name: Copy updated docker-compose template
  ansible.builtin.template:
    src: "docker-compose{{ '-agent' if inventory_hostname in groups['agents'] else '' }}.yml.j2"
    dest: "{{ service_project_src }}/docker-compose.yml"
    mode: '0644'

- name: Set target image details
  ansible.builtin.set_fact:
    target_image: "{{ (lookup('file', service_project_src + '/docker-compose.yml') | from_yaml | selectattr('service', 'equalto', service_name) | first).image  }}"

##############################################################################
# Compare Versions and Determine if Upgrade is Needed
##############################################################################

- name: Initialize version comparison flags
  ansible.builtin.set_fact:
    target_image_match: "{{ target_image | regex_search('^\"?(?P<depName>[^\\s:@\"]+)(?::(?P<currentValue>[-a-zA-Z0-9.]+))?(?:@(?P<currentDigest>sha256:[a-zA-Z0-9]+))?\"?$') }}"
    upgrade_needed: false
    target_image_tag: omit

- name: Set image tag from regex match if found
  ansible.builtin.set_fact:
    target_image_name: "{{ target_image_match.depName }}"
    target_image_tag: "{{ target_image_match.currentValue }}"
  when:
    - target_image_match is defined
    - target_image_match.depName is defined
    - target_image_match.currentValue is defined and target_image_match.currentValue != 'latest'

- name: Handle invalid target image tag (restore and fail)
  when: target_image_tag == omit
  block:
    - name: Check if backup exists before restoring
      ansible.builtin.stat:
        path: "{{ compose_backup_path }}"
      register: restore_target_fail_backup_stat

    - name: Restore docker-compose from backup before failing
      ansible.builtin.command:
        cmd: "mv {{ compose_backup_path }} {{ compose_file_path }}"
      when: restore_target_fail_backup_stat.stat.exists
      changed_when: true
      register: restore_target_fail_result

    - name: Fail playbook due to invalid target tag
      vars:
        msg: |
          ERROR: Cannot determine a valid, non-latest target image tag from the generated docker-compose.yml.
          Image specified: '{{ target_image | default('Not Found') }}'.
          Attempted to restore original compose file from {{ compose_backup_path }}:
          {{ 'Success' if restore_target_fail_result is defined and restore_target_fail_result.changed else ('Backup not found or restore failed' if restore_target_fail_backup_stat.stat.exists else 'Backup not found') }}.
          Upgrade aborted.
      ansible.builtin.fail:
        msg: "{{ msg.split('\n') }}"

- name: Clean current version string for comparison
  ansible.builtin.set_fact:
    current_version_clean: "{{ current_image_tag | regex_replace('^v?((?:\\d+\\.){0,2}\\d+).*$', '\\1') }}"

- name: Clean target version string for comparison
  ansible.builtin.set_fact:
    target_version_clean: "{{ target_image_tag | regex_replace('^v?((?:\\d+\\.){0,2}\\d+).*$', '\\1') }}"

- name: Set final upgrade needed flag based on tag change or version comparison
  ansible.builtin.set_fact:
    upgrade_needed: "{{ target_version_clean is version(current_version_clean, '>') }}"

##############################################################################
# Upgrade Process
##############################################################################

- name: Perform Upgrade and Verification Steps
  when: upgrade_needed
  block:
    - name: Pull updated images
      community.docker.docker_compose_v2:
        project_src: "{{ service_project_src }}"
        pull: "always"
      register: pull_result
      
    - name: Start services with new docker-compose configuration
      community.docker.docker_compose_v2:
        project_src: "{{ service_project_src }}"
        state: present
      register: services_facts
      when: pull_result is defined and pull_result.changed
      
    - name: Wait for services to be running and healthy
      when: services_facts is defined
      community.docker.docker_container_info:
        name: "{{ item.ID }}"
      loop: "{{ services_facts.containers }}"
      loop_control:
        label: "{{ item.Service }}"
      register: container_info
      failed_when: not container_info.container.State.Running or container_info.container.State.Health.Status == 'unhealthy'
      until: container_info.container.State.Running and container_info.container.State.Health.Status == 'healthy'
      delay: 5
      retries: 5
    
    - name: Verify container health state
      ansible.builtin.assert:
        that:
          - container_info.container.State.Health.Status == 'healthy'
          - container_info.container.State.Running
          - container_info.container.Image is search(new_image_tag)
        fail_msg: |
          Services failed to reach healthy state after upgrade or new version was not applied correctly.
          Dozzle health: {{ container_info.container.State.Health.Status }}
          Image verification: {{ 'OK' if container_info.container.Image is search(new_image_tag) else 'FAILED' }}
          
    - name: Set upgrade success flag
      ansible.builtin.set_fact:
        upgrade_success: true

  rescue:
    - name: Check if backup exists before restoring
      ansible.builtin.stat:
        path: "{{ compose_backup_path }}"
      register: restore_target_backup_stat

    - name: Restore docker-compose from backup before failing
      ansible.builtin.command:
        cmd: "mv {{ compose_backup_path }} {{ compose_file_path }}"
      when: restore_target_backup_stat.stat.exists
      changed_when: true
      register: restore_target_backup_result
      
    - name: Start services with original docker-compose configuration
      community.docker.docker_compose_v2:
        project_src: "{{ service_project_src }}"
        state: present
      register: services_facts
      when: restore_target_backup_result is defined and restore_target_backup_result is succeeded
      
    - name: Wait for services to be running and healthy
      when: services_facts is defined
      community.docker.docker_container_info:
        name: "{{ item.ID }}"
      loop: "{{ services_facts.containers }}"
      loop_control:
        label: "{{ item.Service }}"
      register: container_info
      failed_when: not container_info.container.State.Running or container_info.container.State.Health.Status == 'unhealthy'
      until: container_info.container.State.Running and container_info.container.State.Health.Status == 'healthy'
      delay: 5
      retries: 5
      
    - name: Fail playbook due to failed upgrade
      vars:
        msg: |
          ERROR: Failed to upgrade {{ service_name }} to version {{ target_image_tag }}.
          Attempted to restore original compose file from {{ compose_backup_path }}:
          {{ 'Success' if container_info is defined and container_info.container.State.Running and container_info.container.State.Health.Status == 'healthy' else ('Backup restore failed' if restore_target_backup_stat.stat.exists else 'Backup not found') }}.
          Upgrade aborted.
      ansible.builtin.fail:
        msg: "{{ msg.split('\n') }}"

##############################################################################
# Final Report
##############################################################################

- name: Final Upgrade Status Report
  ansible.builtin.debug:
    msg:
      - "Host: {{ inventory_hostname }}"
      - "Initial Version: {{ current_image_name }}:{{ current_image_tag }}"
      - "Target Version: {{ target_image_name }}:{{ target_image_tag }}"
      - "Upgrade Attempted: {{ 'Yes' if upgrade_needed else 'No (Not Required)' }}"
      - "Upgrade Successful: {{ upgrade_success if upgrade_success|default(false) else 'N/A' }}"