##############################################################################
# Initialization
##############################################################################

- name: Set upgrade start time
  ansible.builtin.set_fact:
    upgrade_start_time: "{{ ansible_date_time.iso8601_basic_short }}"
    backup_timestamp: "{{ lookup('pipe', 'date +%Y-%m-%d_%H-%M') }}"

##############################################################################
# Current Version Analysis
##############################################################################

- name: Check current {{ project_name|upper }} container status
  vars:
    project_src: "{{ service_project_src }}"
  ansible.builtin.include_tasks: check.yml
  
- name: Extract current running {{ project_name|upper }} image information
  ansible.builtin.set_fact:
    current_service: "{{ check_result.services | selectattr('service', 'equalto', service_name) | first }}"
  when: check_result.services | selectattr('service', 'equalto', service_name) | length > 0

- name: Verify {{ project_name|upper }} service information is available
  ansible.builtin.assert:
    that:
      - current_service is defined
      - current_service.image is defined
    fail_msg: "Unable to find {{ project_name|upper }} service information in the check results."

- name: Extract current {{ project_name|upper }} version using regex
  ansible.builtin.set_fact:
    current_image_match: "{{ current_service.image | regex_search('^\"?(?P<depName>[^\\s:@\"]+)(?::(?P<currentValue>[-a-zA-Z0-9.]+))?(?:@(?P<currentDigest>sha256:[a-zA-Z0-9]+))?\"?$', '\\1', '\\2', '\\3') }}"
    current_image_tag: omit # Explicitly omit first
  when: current_service.image is defined

- name: Set image tag from regex match if found
  ansible.builtin.set_fact:
    current_image_name: "{{ current_image_match[0] }}"
    current_image_tag: "{{ current_image_match[1] }}"
  when:
    - current_image_match is defined
    - current_image_match[0] is defined
    - current_image_match[1] is defined and current_image_match[1] != 'latest'

- name: Check if current image tag is missing and fail
  when: current_image_tag == omit
  ansible.builtin.fail:
    msg: "ERROR: Cannot determine the current image tag for '{{ current_service.image }}'. Please ensure the running service uses an explicit, non-latest version tag (e.g., 'kopia/kopia:0.19.0') before attempting an upgrade. Upgrade aborted for this host."

##############################################################################
# Compare Versions and Determine if Upgrade is Needed
##############################################################################

- name: Set target image details
  ansible.builtin.set_fact:
    target_image: "{{ (lookup('template', 'docker-compose.yml.j2') | from_yaml).services[service_name].image }}"

- name: Initialize version comparison flags
  ansible.builtin.set_fact:
    target_image_match: "{{ target_image | regex_search('^\"?(?P<depName>[^\\s:@\"]+)(?::(?P<currentValue>[-a-zA-Z0-9.]+))?(?:@(?P<currentDigest>sha256:[a-zA-Z0-9]+))?\"?$', '\\1', '\\2', '\\3')}}"
    upgrade_needed: false
    target_image_tag: omit

- name: Set image tag from regex match if found
  ansible.builtin.set_fact:
    target_image_name: "{{ target_image_match[0] }}"
    target_image_tag: "{{ target_image_match[1] }}"
  when:
    - target_image_match is defined
    - target_image_match[0] is defined
    - target_image_match[1] is defined and target_image_match[1] != 'latest'

- name: Clean current version string for comparison
  ansible.builtin.set_fact:
    current_version_clean: "{{ current_image_tag | regex_replace('^v?((?:\\d+\\.){0,2}\\d+).*$', '\\1') }}"

- name: Clean target version string for comparison
  ansible.builtin.set_fact:
    target_version_clean: "{{ target_image_tag | regex_replace('^v?((?:\\d+\\.){0,2}\\d+).*$', '\\1') }}"

- name: Set final upgrade needed flag based on tag change or version comparison
  ansible.builtin.set_fact:
    upgrade_needed: "{{ target_version_clean is version(current_version_clean, '>') }}"

##############################################################################
# Backup and Prepare for Upgrade
##############################################################################

- name: Backup and Prepare for Upgrade
  when: upgrade_needed
  block:
    - name: Define docker-compose paths
      ansible.builtin.set_fact:
        compose_file_path: "{{ service_project_src }}/docker-compose.yml"
        compose_backup_path: "{{ service_project_src }}/{{ backup_timestamp }}.docker-compose.yml"

    - name: Check if current docker-compose file exists
      ansible.builtin.stat:
        path: "{{ compose_file_path }}"
      register: compose_file_stat

    - name: Backup current docker-compose file
      ansible.builtin.command:
        cmd: "mv {{ compose_file_path }} {{ compose_backup_path }}"
      when: compose_file_stat.stat.exists
      changed_when: true
      register: backup_result

##############################################################################
# Upgrade Process
##############################################################################

- name: Perform Upgrade and Verification Steps
  when: upgrade_needed
  block:
    - name: Copy updated docker-compose template
      ansible.builtin.template:
        src: "docker-compose.yml.j2"
        dest: "{{ service_project_src }}/docker-compose.yml"
        mode: '0644'

    - name: Pull updated images
      community.docker.docker_compose_v2_pull:
        project_src: "{{ service_project_src }}"
      register: pull_result
      
    - name: Start services with new docker-compose configuration
      community.docker.docker_compose_v2:
        project_src: "{{ service_project_src }}"
        state: present
      register: services_facts
      when: pull_result is success
      
    - name: Wait for services to be running
      when: services_facts is defined and services_facts.containers is defined
      community.docker.docker_container_info:
        name: "{{ item.ID }}"
      loop: "{{ services_facts.containers }}"
      loop_control:
        label: "{{ item.Service }}"
      register: container_info
      failed_when: not container_info.container.State.Running
      until: container_info.container.State.Running
      delay: 5
      retries: 5

    - name: Filter kopia container info
      ansible.builtin.set_fact:
        target_container: "{{ item }}"
      loop: "{{ container_info.results | map(attribute='container') }}"
      loop_control:
        label: "{{ item.Name }}"
      when:
        - container_info is defined and container_info.results is defined and container_info.results | length > 0
        - item.Config.Labels['com.docker.compose.service'] == service_name
      
    - name: Verify container is running
      ansible.builtin.assert:
        that:
          - target_container.State.Running
          - target_container.Config.Image is search(target_image_tag)
        fail_msg: |
          Services failed to reach healthy state after upgrade or new version was not applied correctly.
          Image verification: {{ 'OK' if target_container.Config.Image is search(target_image_tag) else 'FAILED' }}
          
    - name: Set upgrade success flag
      ansible.builtin.set_fact:
        upgrade_success: true

  rescue:
    - name: Check if backup exists before restoring
      ansible.builtin.stat:
        path: "{{ compose_backup_path }}"
      register: restore_target_backup_stat

    - name: Restore docker-compose from backup before failing
      ansible.builtin.command:
        cmd: "mv {{ compose_backup_path }} {{ compose_file_path }}"
      when: restore_target_backup_stat.stat.exists
      register: restore_target_backup_result
      
    - name: Start services with original docker-compose configuration
      community.docker.docker_compose_v2:
        project_src: "{{ service_project_src }}"
        state: present
      register: services_facts
      when: restore_target_backup_result is defined and restore_target_backup_result.rc == 0
      
    - name: Wait for services to be running and healthy
      when: services_facts is defined and services_facts.containers is defined
      community.docker.docker_container_info:
        name: "{{ item.ID }}"
      loop: "{{ services_facts.containers }}"
      loop_control:
        label: "{{ item.Service }}"
      register: container_info
      failed_when: not container_info.container.State.Running or container_info.container.State.Health.Status == 'unhealthy'
      until: container_info.container.State.Running and container_info.container.State.Health.Status == 'healthy'
      delay: 5
      retries: 5
      
    - name: Filter kopia container info
      ansible.builtin.set_fact:
        target_container: "{{ item }}"
      loop: "{{ container_info.results | map(attribute='container') }}"
      loop_control:
        label: "{{ item.Name }}"
      when:
        - container_info is defined and container_info.results is defined and container_info.results | length > 0
        - item.Config.Labels['com.docker.compose.service'] == service_name
        
    - name: Report failed upgrade
      vars:
        msg: |
          ERROR: Failed to upgrade {{ service_name }} to version {{ target_image_tag }}.
          Attempted to restore original compose file from {{ compose_backup_path }}:
          {{ 'Success' if target_container is defined and target_container.State.Running and target_container.State.Health.Status == 'healthy' else ('Backup restore failed' if restore_target_backup_stat.stat.exists else 'Backup not found') }}.
          Upgrade aborted.
      ansible.builtin.debug:
        msg: "{{ msg.split('\n') }}"
        
    - name: Fail playbook due to failed upgrade
      ansible.builtin.fail:
        msg: "Failed to upgrade {{ service_name }} to version {{ target_image_tag }}."
        
##############################################################################
# Clean up
##############################################################################

- name: Clean up backup docker compose when upgrade success
  become: true
  ansible.builtin.file:
    path: "{{ compose_backup_path }}"
    state: absent
  when: backup_result.rc is defined and backup_result.rc == 0

##############################################################################
# Final Report
##############################################################################

- name: Final Upgrade Status Report
  ansible.builtin.debug:
    msg:
      - "Initial Version: {{ current_image_name }}:{{ current_image_tag }}"
      - "Target Version: {{ target_image_name }}:{{ target_image_tag }}"
      - "Upgrade Attempted: {{ 'Yes' if upgrade_needed else 'No (Not Required)' }}"
      - "Upgrade Successful: {{ upgrade_success if upgrade_success|default(false) else 'N/A' }}"