---
# Forgejo and PostgreSQL Backup Tasks
# 
# This file implements a backup strategy using Docker's native commands for Forgejo and PostgreSQL.
# Key concepts:
# - Stops Forgejo service completely during backup (following official guidance)
# - Uses 'forgejo dump' and 'pg_dump' commands for creating backups
# - Uses docker compose run/exec for running one-shot commands
# - Copies generated backup files to host using docker compose cp
# - Creates timestamp-based backup directories
# - Performs health checks to verify service status
# - Supports standard mode (restart service) and update mode (keep service stopped)

#################################################
# Service Control - Stop Services
#################################################

- name: Set up Forgejo Rootless project source path
  ansible.builtin.set_fact:
    forgejo_project_src: "{{ forgejo_project_src|default(ansible_user_dir + '/Docker/forgejo-rootless') }}"

- name: Make sure services are down
  community.docker.docker_compose_v2:
    project_src: "{{ forgejo_project_src }}"
    services:
    state: absent
  register: stop_result

#################################################
# Initialization and Setup
#################################################

- name: Set backup timestamp
  ansible.builtin.set_fact:
    backup_timestamp: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"
    backup_succeeded: false
    postgres_backup_succeeded: false
    postgres_backup_filename: "forgejo-db-backup.dump"
    forgejo_backup_succeeded: false
    forgejo_backup_filename: "forgejo-app-dump.zip"
    restore_services: true

- name: Check if backup directory is defined in inventory
  ansible.builtin.set_fact:
    forgejo_backup_dir: "{{ forgejo_backup_dir|default(forgejo_project_src + '/backups') }}"

- name: Set current backup directory path
  ansible.builtin.set_fact:
    current_backup_dir: "{{ forgejo_backup_dir }}/{{ backup_timestamp }}"

- name: Create base backup directory if it doesn't exist
  ansible.builtin.file:
    path: "{{ forgejo_backup_dir }}"
    state: directory
    mode: '0755'

- name: Check if update mode is enabled
  ansible.builtin.set_fact:
    restore_services: "{{ not (update_mode|default(false)|bool) }}"
  when: update_mode is defined

- name: Show backup mode
  ansible.builtin.debug:
    msg: "Running in {{ 'UPDATE mode - services will remain STOPPED after backup' if not restore_services else 'STANDARD mode - services will be RESTARTED after backup' }}"
    
- name: Create timestamp-based backup directory
  ansible.builtin.file:
    path: "{{ current_backup_dir }}"
    state: directory
    mode: '0755'

#################################################
# Backup Execution
#################################################

- name: Execute backup processes
  block:
    #----- Application Backup - Forgejo -----#
    - name: Execute Forgejo backup process
      block:
        - name: Setup Forgejo backup variables
          ansible.builtin.set_fact:
            forgejo_container_backup_filepath: "/var/lib/gitea/{{ forgejo_backup_filename }}"

        - name: Launch Forgejo backup container with sleep command
          community.docker.docker_compose_v2_run:
            project_src: "{{ forgejo_project_src }}"
            service: forgejo
            command: dummy sh -c "sleep 3600" # Keep container alive for 1 hour (more than enough for backup)
            detach: true
          register: forgejo_backup_container

        - name: Set backup container ID
          ansible.builtin.set_fact:
            forgejo_backup_container_id: "{{ forgejo_backup_container.container_id }}"
          when: forgejo_backup_container.container_id is defined

        - name: Run Forgejo dump command in the backup container
          community.docker.docker_container_exec:
            container: "{{ forgejo_backup_container_id }}"
            command: forgejo dump -f {{ forgejo_container_backup_filepath }}
          register: forgejo_dump_result
          when: forgejo_backup_container_id is defined

        - name: Copy Forgejo backup from container to host
          ansible.builtin.command:
            cmd: docker cp {{ forgejo_backup_container_id }}:{{ forgejo_container_backup_filepath }} {{ current_backup_dir }}/{{ forgejo_backup_filename }}
          register: forgejo_copy_result
          when: forgejo_dump_result is success

        - name: Mark Forgejo backup as successful
          ansible.builtin.set_fact:
            forgejo_backup_succeeded: true
          when: forgejo_dump_result is success and forgejo_copy_result is success
      rescue:
        - name: Record Forgejo backup failure
          ansible.builtin.set_fact:
            forgejo_backup_succeeded: false
            forgejo_backup_error: "{{ ansible_failed_task.name|default('Unknown error') }}"
      always:
        - name: Clean up temporary Forgejo backup file in container
          community.docker.docker_compose_v2_exec:
            project_src: "{{ forgejo_project_src }}"
            service: forgejo
            command: rm -f {{ forgejo_container_backup_filepath }}
          when: forgejo_dump_result is defined and forgejo_dump_result is success

        - name: Check if Forgejo backup container exists
          community.docker.docker_container_info:
            name: "{{ forgejo_backup_container_id }}"
          register: forgejo_backup_container_info
          when: forgejo_backup_container_id is defined

        - name: Clean up Forgejo backup container
          community.docker.docker_container:
            name: "{{ forgejo_backup_container_id }}"
            state: absent
            force_kill: true
            keep_volumes: false
          when: forgejo_backup_container_info.exists

    #----- Database Backup - PostgreSQL -----#
    - name: Execute PostgreSQL backup process
      block:
        - name: Setup PostgreSQL backup variables
          ansible.builtin.set_fact:
            postgres_container_backup_filepath: "/var/lib/postgresql/data/{{ postgres_backup_filename }}"

        - name: Backup PostgreSQL database using docker compose exec
          community.docker.docker_compose_v2_exec:
            project_src: "{{ forgejo_project_src }}"
            service: forgejo-db
            command: pg_dump -Fc -U {{ db_user }} {{ db_name }} -f {{ postgres_container_backup_filepath }}
          register: pg_dump_result

        - name: Copy PostgreSQL backup from container to host
          ansible.builtin.command:
            cmd: docker compose cp forgejo-db:{{ postgres_container_backup_filepath }} {{ current_backup_dir }}/{{ postgres_backup_filename }}
            chdir: "{{ forgejo_project_src }}"
          register: pg_copy_result
          when: pg_dump_result is success

        - name: Mark PostgreSQL backup as successful
          ansible.builtin.set_fact:
            postgres_backup_succeeded: true
          when: pg_dump_result is success and pg_copy_result is success
      rescue:
        - name: Record PostgreSQL backup failure
          ansible.builtin.set_fact:
            postgres_backup_succeeded: false
            postgres_backup_error: "{{ ansible_failed_task.name|default('Unknown error') }}"
      always:
        - name: Clean up temporary PostgreSQL backup file in container
          community.docker.docker_compose_v2_exec:
            project_src: "{{ forgejo_project_src }}"
            service: forgejo-db
            command: rm -f {{ postgres_container_backup_filepath }}
          when: pg_dump_result is defined and pg_dump_result is success
  rescue:
    - name: Record overall backup failure
      ansible.builtin.set_fact:
        backup_error: "{{ ansible_failed_task.name|default('Unknown error in backup process') }}"
        backup_succeeded: false
      
    - name: Notify service restart handler if in standard mode
      ansible.builtin.debug:
        msg: "Notifying service restart handler"
      changed_when: true
      notify: Restore services
      when: restore_services|bool

#################################################
# Backup Status and Reporting
#################################################

- name: Set overall backup success status
  ansible.builtin.set_fact:
    backup_succeeded: "{{ postgres_backup_succeeded or forgejo_backup_succeeded }}"

- name: Create backup report
  ansible.builtin.copy:
    dest: "{{ current_backup_dir }}/BACKUP_REPORT.md"
    content: |
      # Backup Report

      **Timestamp:** {{ backup_timestamp }}
      **Mode:** {{ 'UPDATE' if not restore_services else 'STANDARD' }}

      ## Components Status

      | Component | Status | Details |
      |-----------|--------|--------|
      | PostgreSQL | {{ 'SUCCESS ✅' if postgres_backup_succeeded else 'FAILED ❌' }} | {{ postgres_backup_error | default('') if not postgres_backup_succeeded else '' }} |
      | Forgejo | {{ 'SUCCESS ✅' if forgejo_backup_succeeded else 'FAILED ❌' }} | {{ forgejo_backup_error | default('') if not forgejo_backup_succeeded else '' }} |

      ## Summary
      
      Overall backup status: {{ 'SUCCESS ✅' if backup_succeeded else 'FAILED ❌' }}
      {% if backup_error is defined and not backup_succeeded %}
      Error: {{ backup_error }}
      {% endif %}
      
      {% if restore_services %}
      Services were restarted after backup.
      {% else %}
      Services remained stopped after backup (UPDATE mode).
      {% endif %}
    mode: '0644'
  when: postgres_backup_succeeded or forgejo_backup_succeeded

#################################################
# Cleanup and Service Restoration
#################################################

- name: Show final backup status
  ansible.builtin.debug:
    msg: >
      Backup {{ 'SUCCEEDED' if backup_succeeded else 'FAILED' }}.
      PostgreSQL: {{ 'OK' if postgres_backup_succeeded else 'FAILED' }}{% if postgres_backup_error is defined and not postgres_backup_succeeded %} ({{ postgres_backup_error }}){% endif %}.
      Forgejo: {{ 'OK' if forgejo_backup_succeeded else 'FAILED' }}{% if forgejo_backup_error is defined and not forgejo_backup_succeeded %} ({{ forgejo_backup_error }}){% endif %}.
      {{ 'Services were restarted.' if restore_services else 'Services remain STOPPED (update mode).' }}
      
- name: Clean up backup files if backup failed
  ansible.builtin.file:
    path: "{{ current_backup_dir }}/{{ item }}"
    state: absent
  loop:
    - "forgejo-app-dump.zip"
    - "forgejo-db-backup.dump"
  when: not backup_succeeded

- name: Fail task if backup failed
  ansible.builtin.fail:
    msg: "Backup failed: {{ backup_error }}"
  when: not backup_succeeded
