---
# Frgejo and PostgreSQL Backup Tasks
# 
# This file implements a backup strategy using Docker's native commands for Forgejo and PostgreSQL.
# Key concepts:
# - Stops Forgejo service completely during backup (following official guidance)
# - Uses 'forgejo dump' and 'pg_dump' commands for creating backups
# - Uses docker compose run/exec for running one-shot commands
# - Copies generated backup files to host using docker compose cp
# - Creates timestamp-based backup directories
# - Performs health checks to verify service status
# - Supports standard mode (restart service) and update mode (keep service stopped)

#################################################
# Service Control - Stop Services
#################################################

- name: Verify backup directory is defined
  ansible.builtin.assert:
    that:
      - forgejo_backup_dir is defined
    fail_msg: "Required variable forgejo_backup_dir is not defined. Please specify the path to the backup directory."

- name: Check services status
  vars:
    files_list: "{{ forgejo_files_list }}"
    project_src: "{{ service_project_src }}"
  ansible.builtin.include_tasks: check.yml

- name: Get services info
  ansible.builtin.set_fact:
    forgejo_services_check_result: "{{ check_result }}"

- name: Make sure services are stopped before backup
  community.docker.docker_compose_v2:
    project_src: "{{ service_project_src }}"
    services: "{{ item.service }}"
    state: stopped
  loop: "{{ forgejo_services_check_result.services }}"
  loop_control:
    label: "{{ item.service }}"

#################################################
# Initialization and Setup
#################################################

- name: Set up backup variables
  ansible.builtin.set_fact:
    backup_timestamp: "{{ ansible_date_time.iso8601 }}"
    backup_succeeded: false
    postgres_backup_succeeded: false
    postgres_backup_filename: "forgejo-db-backup.dump"
    forgejo_backup_succeeded: false
    forgejo_backup_filename: "forgejo-app-dump.zip"
    config_backup_succeeded: false

- name: Create base backup directory if it doesn't exist
  become: true
  ansible.builtin.file:
    path: "{{ forgejo_backup_dir }}"
    state: directory
    mode: '0755'
    owner: "{{ forgejo_user_id }}"
    group: "{{ forgejo_group_id }}"
    
- name: Show backup mode
  ansible.builtin.debug:
    msg: "Running in BACKUP mode - services state will be ROLLED BACK after backup"

#################################################
# Pre-Execution
#################################################

- name: Prepare for rollback by managing existing content
  become: true
  block:
    - name: Find existing items in backup directory
      ansible.builtin.find:
        paths: "{{ forgejo_backup_dir }}"
        recurse: false
        hidden: true
      register: existing_backup_items

    - name: Set has existing backup
      ansible.builtin.set_fact:
        has_existing_backup: existing_backup_items.examined is defined and existing_backup_items.examined > 0

    - name: Ensure rollback directory exists
      ansible.builtin.file:
        path: "{{ forgejo_backup_dir }}/rollback"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}" # Or forgejo_user_id if needed later
        group: "{{ ansible_user }}" # Or forgejo_group_id
      when: has_existing_backup

    - name: Move existing items to rollback directory
      ansible.builtin.command:
        cmd: "mv {{ item.path }} {{ forgejo_backup_dir }}/rollback/"
      loop: "{{ existing_backup_items.files }}"
      loop_control:
        label: "{{ item.path|basename }}"
      when: has_existing_backup

#################################################
# Backup Execution
#################################################

- name: Execute backup processes
  block:
    - name: Create backup directory and copy docker-compose backup file
      block:
        - name: Copy docker-compose backup file
          ansible.builtin.template:
            src: "docker-compose.backup.yml.j2"
            dest: "{{ service_project_src }}/docker-compose.backup.yml"
            mode: '0644'
          register: copy_docker_compose_backup_result

    #----- Project Setup Backup - Docker Compose and Secrets -----#
    - name: Execute Project Setup backup process
      block:
        - name: Copy docker-compose.yml to backup location
          become: true
          ansible.builtin.copy:
            src: "{{ service_project_src }}/docker-compose.yml"
            dest: "{{ forgejo_backup_dir }}/docker-compose.yml"
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: '0644'
            remote_src: true
          register: docker_compose_backup_results

        - name: Check if secrets directory exists
          ansible.builtin.stat:
            path: "{{ service_project_src }}/secrets"
          register: secrets_dir

        - name: Copy secrets files to backup location
          become: true
          ansible.builtin.copy:
            src: "{{ service_project_src }}/secrets"
            dest: "{{ forgejo_backup_dir }}"
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: '0644'
            remote_src: true
          when: secrets_dir.stat.exists
          register: secrets_backup

        - name: Mark project setup backup as successful
          ansible.builtin.set_fact:
            config_backup_succeeded: true
          when: docker_compose_backup_results is success and secrets_backup is success
      rescue:
        - name: Record project setup backup failure
          ansible.builtin.set_fact:
            config_backup_succeeded: false
            config_backup_error: "{{ ansible_failed_task.name|default('Unknown error') }}"

    #----- Application Backup - Forgejo -----#
    - name: Execute Forgejo backup process
      block:
        - name: Setup Forgejo container backup filepath
          ansible.builtin.set_fact:
            forgejo_container_backup_filepath: "/tmp/backup/{{ forgejo_backup_filename }}"

        - name: Launch Forgejo backup container with sleep command
          community.docker.docker_compose_v2_run:
            project_src: "{{ service_project_src }}"
            files:
              - "{{ copy_docker_compose_backup_result.dest }}"
            service: forgejo
            command: sh -c "sleep infinity" # Keep container alive indefinitely during backup process
            detach: true
          register: forgejo_backup_container
          when: copy_docker_compose_backup_result is success

        - name: Set backup container ID
          ansible.builtin.set_fact:
            forgejo_backup_container_id: "{{ forgejo_backup_container.container_id }}"
          when: forgejo_backup_container.container_id is defined

        - name: Run Forgejo dump command in the backup container
          community.docker.docker_container_exec:
            container: "{{ forgejo_backup_container_id }}"
            command: forgejo dump -f {{ forgejo_container_backup_filepath }}
          register: forgejo_dump_result
          when: forgejo_backup_container_id is defined
          
        - name: Check if backup file exists
          become: true
          ansible.builtin.stat:
            path: "{{ forgejo_backup_dir }}/{{ forgejo_backup_filename }}"
          register: forgejo_backup_file
          when: forgejo_dump_result is success

        - name: Mark Forgejo backup as successful
          ansible.builtin.set_fact:
            forgejo_backup_succeeded: true
          when: forgejo_dump_result is success and forgejo_backup_file.stat.exists
      rescue:
        - name: Record Forgejo backup failure
          ansible.builtin.set_fact:
            forgejo_backup_succeeded: false
            forgejo_backup_error: "{{ ansible_failed_task.name|default('Unknown error') }}"
        
        - name: Fail task to propagate error to parent block
          ansible.builtin.fail:
            msg: "Forgejo backup component failed: {{ ansible_failed_task.name|default('Unknown error') }}"
      always:
        - name: Check if Forgejo backup container exists
          community.docker.docker_container_info:
            name: "{{ forgejo_backup_container_id }}"
          register: forgejo_backup_container_info
          when: forgejo_backup_container_id is defined

        - name: Remove Forgejo backup container
          community.docker.docker_container:
            name: "{{ forgejo_backup_container_id }}"
            state: absent
            force_kill: true
            keep_volumes: false
          when: forgejo_backup_container_info.exists

    #----- Database Backup - PostgreSQL -----#
    - name: Execute PostgreSQL backup process
      block:
        - name: Setup PostgreSQL container backup filepath
          ansible.builtin.set_fact:
            postgres_container_backup_filepath: "/tmp/backup/{{ postgres_backup_filename }}"

        - name: Backup PostgreSQL database using docker compose exec
          community.docker.docker_compose_v2_exec:
            project_src: "{{ service_project_src }}"
            files:
              - "{{ copy_docker_compose_backup_result.dest }}"
            service: forgejo-db
            command: pg_dump -Fc -U {{ db_user }} {{ db_name }} -f {{ postgres_container_backup_filepath }}
          register: pg_dump_result
          when: copy_docker_compose_backup_result is success
          
        - name: Check if PostgreSQL backup file exists
          become: true
          ansible.builtin.stat:
            path: "{{ forgejo_backup_dir }}/{{ postgres_backup_filename }}"
          register: postgres_backup_file
          when: pg_dump_result is success

        - name: Mark PostgreSQL backup as successful
          ansible.builtin.set_fact:
            postgres_backup_succeeded: true
          when: pg_dump_result is success and postgres_backup_file.stat.exists
      rescue:
        - name: Record PostgreSQL backup failure
          ansible.builtin.set_fact:
            postgres_backup_succeeded: false
            postgres_backup_error: "{{ ansible_failed_task.name|default('Unknown error') }}"
            
        - name: Fail task to propagate error to parent block
          ansible.builtin.fail:
            msg: "PostgreSQL backup component failed: {{ ansible_failed_task.name|default('Unknown error') }}"
  rescue:
    - name: Record overall backup failure
      ansible.builtin.set_fact:
        backup_failure_reason: "{{ ansible_failed_task.name|default('Unknown error in backup process') }}"
        backup_succeeded: false
        
    - name: Notify Rollback services handler
      ansible.builtin.debug:
        msg: "Notifying service rollback handler due to backup failure"
      changed_when: true
      notify: Rollback services
  always:
    - name: Clean up docker-compose backup file
      ansible.builtin.file:
        path: "{{ copy_docker_compose_backup_result.dest }}"
        state: absent
      when: copy_docker_compose_backup_result is defined and copy_docker_compose_backup_result is success

#################################################
# Backup Status and Reporting
#################################################

- name: Set overall backup success status
  ansible.builtin.set_fact:
    backup_succeeded: "{{ postgres_backup_succeeded and forgejo_backup_succeeded and config_backup_succeeded|default(false) }}"
    
- name: Get services info
  ansible.builtin.set_fact:
    forgejo_service_info: "{{ forgejo_services_check_result.services | selectattr('service', 'equalto', 'forgejo') | list }}"
    postgres_service_info: "{{ forgejo_services_check_result.services | selectattr('service', 'equalto', 'forgejo-db') | list }}"
    
- name: Get service image versions
  ansible.builtin.set_fact:
    forgejo_image_version: "{{ forgejo_service_info[0].image if forgejo_service_info is defined and forgejo_service_info|length > 0 else 'unknown' }}"
    postgres_image_version: "{{ postgres_service_info[0].image if postgres_service_info is defined and postgres_service_info|length > 0 else 'unknown' }}"

- name: Create backup report
  become: true
  ansible.builtin.copy:
    dest: "{{ forgejo_backup_dir }}/BACKUP_REPORT.md"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
    content: |
      # Backup Report

      **Timestamp:** {{ backup_timestamp }}
      **Mode:** 'BACKUP'

      ## Versions
      **Forgejo:** {{ forgejo_image_version }}
      **PostgreSQL:** {{ postgres_image_version }}

      ## Components Status

      | Component | Status | Details |
      |-----------|--------|--------|
      | PostgreSQL | {{ 'SUCCESS ✅' if postgres_backup_succeeded else 'FAILED ❌' }} | {{ postgres_backup_error | default('') if not postgres_backup_succeeded else '' }} |
      | Forgejo | {{ 'SUCCESS ✅' if forgejo_backup_succeeded else 'FAILED ❌' }} | {{ forgejo_backup_error | default('') if not forgejo_backup_succeeded else '' }} |
      | Project Setup | {{ 'SUCCESS ✅' if config_backup_succeeded|default(false) else 'FAILED ❌' }} | {{ config_backup_error | default('') if not config_backup_succeeded|default(false) else '' }} |

      ## Summary
      
      Overall backup status: {{ 'SUCCESS ✅' if backup_succeeded else 'FAILED ❌' }}
      {% if backup_failure_reason is defined and not backup_succeeded %}
      Error: {{ backup_failure_reason }}
      {% endif %}
  when: postgres_backup_succeeded or forgejo_backup_succeeded or config_backup_succeeded|default(false)

#################################################
# Kopia Backup
#################################################

- name: Include kopia tasks
  ansible.builtin.include_tasks: kopia.yml
  when: backup_succeeded|bool and use_kopia|bool

#################################################
# Cleanup and Service Restoration
#################################################

- name: Notify Rollback services handler
  ansible.builtin.debug:
    msg: "Notifying Rollback services handler"
  when: backup_succeeded|bool and operation_mode != 'upgrade'
  changed_when: true
  notify: Rollback services
  
- name: Show final backup status
  vars:
    msg: |
      Backup {{ 'SUCCEEDED ✅' if backup_succeeded else 'FAILED ❌' }}.
      PostgreSQL: {{ 'OK ✅' if postgres_backup_succeeded else 'FAILED ❌' }}{% if postgres_backup_error is defined and not postgres_backup_succeeded %} ({{ postgres_backup_error }}){% endif %}.
      Forgejo: {{ 'OK ✅' if forgejo_backup_succeeded else 'FAILED ❌' }}{% if forgejo_backup_error is defined and not forgejo_backup_succeeded %} ({{ forgejo_backup_error }}){% endif %}.
      Project Setup: {{ 'OK ✅' if config_backup_succeeded|default(false) else 'FAILED ❌' }}{% if config_backup_error is defined and not config_backup_succeeded|default(false) %} ({{ config_backup_error }}){% endif %}.
      {% if kopia_snapshot_result is defined and kopia_snapshot_result is success %}
      Kopia: {{ 'OK ✅' if kopia_snapshot_result.rc is defined and kopia_snapshot_result.rc == 0 else 'FAILED ❌' }}
        {% if kopia_snapshot_result.rc is defined and kopia_snapshot_result.rc != 0 %} 
        {{ kopia_snapshot_result.stderr|default('') }}
        {% endif %}.
      {% endif %}
      Services state will be ROLLED BACK.
  ansible.builtin.debug:
    msg: "{{ msg.split('\n') }}"
      
- name: Check if rollback directory exists
  become: true
  ansible.builtin.stat:
    path: "{{ forgejo_backup_dir }}/rollback"
  register: rollback_dir_stat

- name: Clean up rollback directory
  become: true
  when: rollback_dir_stat.stat.exists and rollback_dir_stat.stat.isdir
  block:
    - name: Restore files from rollback directory
      when: not backup_succeeded
      block:
        - name: Find items in rollback directory
          ansible.builtin.find:
            paths: "{{ forgejo_backup_dir }}/rollback"
            hidden: true
            register: rollback_items

        - name: Move items from rollback to main backup directory
          ansible.builtin.command:
            cmd: "mv {{ item.path }} {{ forgejo_backup_dir }}/"
          loop: "{{ rollback_items.files }}"
          loop_control:
            label: "{{ item.path | basename }}"

    - name: Remove empty rollback directory
      ansible.builtin.file:
        path: "{{ forgejo_backup_dir }}/rollback"
        state: absent

- name: Clean up backup files and restore rollback files
  when: not backup_succeeded
  block:
    - name: Clean up backup files if backup failed
      ansible.builtin.file:
        path: "{{ forgejo_backup_dir }}/{{ item }}"
        state: absent
      loop:
        - "{{ forgejo_backup_filename }}"
        - "{{ postgres_backup_filename }}"

    - name: Fail task if backup failed
      ansible.builtin.fail:
        msg: "Backup failed: {{ backup_timestamp }}"