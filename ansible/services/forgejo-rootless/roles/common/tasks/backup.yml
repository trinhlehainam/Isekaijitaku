---
# Forgejo and PostgreSQL Backup Tasks
# 
# This file implements a backup strategy using Docker's native commands for Forgejo and PostgreSQL.
# Key concepts:
# - Stops Forgejo service completely during backup (following official guidance)
# - Uses 'forgejo dump' and 'pg_dump' commands for creating backups
# - Uses docker compose run/exec for running one-shot commands
# - Copies generated backup files to host using docker compose cp
# - Creates timestamp-based backup directories
# - Performs health checks to verify service status
# - Supports standard mode (restart service) and update mode (keep service stopped)

#################################################
# Service Control - Stop Services
#################################################

- name: Check services status
  ansible.builtin.include_tasks: check.yml

- name: Make sure services are stopped before backup
  community.docker.docker_compose_v2:
    project_src: "{{ forgejo_project_src }}"
    services: "{{ item.service }}"
    state: stopped
  loop: "{{ check_result.services }}"
  loop_control:
    label: "{{ item.service }}"

#################################################
# Initialization and Setup
#################################################

- name: Set up backup variables
  ansible.builtin.set_fact:
    backup_timestamp: "{{ lookup('pipe', 'date +%Y-%m-%d_%H-%M') }}"
    backup_succeeded: false
    postgres_backup_succeeded: false
    postgres_backup_filename: "forgejo-db-backup.dump"
    forgejo_backup_succeeded: false
    forgejo_backup_filename: "forgejo-app-dump.zip"
    config_backup_succeeded: false

- name: Extract Forgejo and PostgreSQL version information
  ansible.builtin.set_fact:
    forgejo_image: "{{ check_result.services| selectattr('service', 'equalto', 'forgejo') | map(attribute='image') | first | default('unknown') }}"
    postgres_image: "{{ check_result.services | selectattr('service', 'equalto', 'forgejo-db') | map(attribute='image') | first | default('unknown') }}"

- name: Check if backup directory is defined in inventory
  ansible.builtin.set_fact:
    forgejo_backup_dir: "{{ forgejo_backup_dir|default(forgejo_project_src + '/backups') }}"

- name: Set current backup directory path
  ansible.builtin.set_fact:
    current_backup_dir: "{{ forgejo_backup_dir }}/{{ backup_timestamp }}"

- name: Create base backup directory if it doesn't exist
  ansible.builtin.file:
    path: "{{ forgejo_backup_dir }}"
    state: directory
    mode: '0755'

- name: Show backup mode
  ansible.builtin.debug:
    msg: "Running in BACKUP mode - services state will be ROLLED BACK after backup"
    
- name: Create timestamp-based backup directory
  ansible.builtin.file:
    path: "{{ current_backup_dir }}"
    state: directory
    mode: '0755'

#################################################
# Backup Execution
#################################################

- name: Execute backup processes
  block:
    #----- Project Setup Backup - Docker Compose and Secrets -----#
    - name: Execute Project Setup backup process
      block:
        - name: Create project setup directories in backup location
          ansible.builtin.file:
            path: "{{ current_backup_dir }}/setup"
            state: directory
            mode: '0755'
          register: setup_dir_created

        - name: Copy docker-compose.yml to backup location
          ansible.builtin.copy:
            src: "{{ forgejo_project_src }}/docker-compose.yml"
            dest: "{{ current_backup_dir }}/setup/docker-compose.yml"
            mode: '0644'
            remote_src: true
          register: docker_compose_backup
          when: setup_dir_created is success

        - name: Check if secrets directory exists
          ansible.builtin.stat:
            path: "{{ forgejo_project_src }}/secrets"
          register: secrets_dir

        - name: Copy secrets files to backup location
          ansible.builtin.copy:
            src: "{{ forgejo_project_src }}/secrets"
            dest: "{{ current_backup_dir }}/setup"
            remote_src: true
          when: secrets_dir.stat.exists
          register: secrets_backup

        - name: Mark project setup backup as successful
          ansible.builtin.set_fact:
            config_backup_succeeded: true
          when: docker_compose_backup is success and secrets_backup is success
      rescue:
        - name: Record project setup backup failure
          ansible.builtin.set_fact:
            config_backup_succeeded: false
            config_backup_error: "{{ ansible_failed_task.name|default('Unknown error') }}"

    #----- Application Backup - Forgejo -----#
    - name: Execute Forgejo backup process
      block:
        - name: Setup Forgejo backup variables
          ansible.builtin.set_fact:
            forgejo_container_backup_filepath: "/var/lib/gitea/{{ forgejo_backup_filename }}"

        - name: Launch Forgejo backup container with sleep command
          community.docker.docker_compose_v2_run:
            project_src: "{{ forgejo_project_src }}"
            service: forgejo
            command: dummy sh -c "sleep infinity" # Keep container alive indefinitely during backup process
            detach: true
          register: forgejo_backup_container

        - name: Set backup container ID
          ansible.builtin.set_fact:
            forgejo_backup_container_id: "{{ forgejo_backup_container.container_id }}"
          when: forgejo_backup_container.container_id is defined

        - name: Run Forgejo dump command in the backup container
          community.docker.docker_container_exec:
            container: "{{ forgejo_backup_container_id }}"
            command: forgejo dump -f {{ forgejo_container_backup_filepath }}
          register: forgejo_dump_result
          ignore_errors: "{{ operation_mode == 'upgrade' }}"
          when: forgejo_backup_container_id is defined

        - name: Copy Forgejo backup from container to host
          ansible.builtin.command:
            cmd: docker cp {{ forgejo_backup_container_id }}:{{ forgejo_container_backup_filepath }} {{ current_backup_dir }}/{{ forgejo_backup_filename }}
          register: forgejo_copy_result
          when: forgejo_dump_result is success

        - name: Mark Forgejo backup as successful
          ansible.builtin.set_fact:
            forgejo_backup_succeeded: true
          when: forgejo_dump_result is success and forgejo_copy_result is success
      rescue:
        - name: Record Forgejo backup failure
          ansible.builtin.set_fact:
            forgejo_backup_succeeded: false
            forgejo_backup_error: "{{ ansible_failed_task.name|default('Unknown error') }}"
        
        - name: Fail task to propagate error to parent block
          ansible.builtin.fail:
            msg: "Forgejo backup component failed: {{ ansible_failed_task.name|default('Unknown error') }}"
      always:
        - name: Clean up temporary Forgejo backup file in container
          community.docker.docker_compose_v2_exec:
            project_src: "{{ forgejo_project_src }}"
            service: forgejo
            command: rm -f {{ forgejo_container_backup_filepath }}
          when: forgejo_dump_result is defined and forgejo_dump_result is success

        - name: Check if Forgejo backup container exists
          community.docker.docker_container_info:
            name: "{{ forgejo_backup_container_id }}"
          register: forgejo_backup_container_info
          when: forgejo_backup_container_id is defined

        - name: Clean up Forgejo backup container
          community.docker.docker_container:
            name: "{{ forgejo_backup_container_id }}"
            state: absent
            force_kill: true
            keep_volumes: false
          when: forgejo_backup_container_info.exists

    #----- Database Backup - PostgreSQL -----#
    - name: Execute PostgreSQL backup process
      block:
        - name: Setup PostgreSQL backup variables
          ansible.builtin.set_fact:
            postgres_container_backup_filepath: "/var/lib/postgresql/data/{{ postgres_backup_filename }}"

        - name: Backup PostgreSQL database using docker compose exec
          community.docker.docker_compose_v2_exec:
            project_src: "{{ forgejo_project_src }}"
            service: forgejo-db
            command: pg_dump -Fc -U {{ db_user }} {{ db_name }} -f {{ postgres_container_backup_filepath }}
          register: pg_dump_result

        - name: Copy PostgreSQL backup from container to host
          ansible.builtin.command:
            cmd: docker compose cp forgejo-db:{{ postgres_container_backup_filepath }} {{ current_backup_dir }}/{{ postgres_backup_filename }}
            chdir: "{{ forgejo_project_src }}"
          register: pg_copy_result
          when: pg_dump_result is success

        - name: Mark PostgreSQL backup as successful
          ansible.builtin.set_fact:
            postgres_backup_succeeded: true
          when: pg_dump_result is success and pg_copy_result is success
      rescue:
        - name: Record PostgreSQL backup failure
          ansible.builtin.set_fact:
            postgres_backup_succeeded: false
            postgres_backup_error: "{{ ansible_failed_task.name|default('Unknown error') }}"
            
        - name: Fail task to propagate error to parent block
          ansible.builtin.fail:
            msg: "PostgreSQL backup component failed: {{ ansible_failed_task.name|default('Unknown error') }}"
      always:
        - name: Clean up temporary PostgreSQL backup file in container
          community.docker.docker_compose_v2_exec:
            project_src: "{{ forgejo_project_src }}"
            service: forgejo-db
            command: rm -f {{ postgres_container_backup_filepath }}
          when: pg_dump_result is defined and pg_dump_result is success
  rescue:
    - name: Record overall backup failure
      ansible.builtin.set_fact:
        backup_failure_reason: "{{ ansible_failed_task.name|default('Unknown error in backup process') }}"
        backup_succeeded: false
        
    - name: Notify Rollback services handler
      ansible.builtin.debug:
        msg: "Notifying service rollback handler due to backup failure"
      changed_when: true
      notify: Rollback services

#################################################
# Backup Status and Reporting
#################################################

- name: Set overall backup success status
  ansible.builtin.set_fact:
    backup_succeeded: "{{ postgres_backup_succeeded and forgejo_backup_succeeded and config_backup_succeeded|default(false) }}"

- name: Create backup report
  ansible.builtin.copy:
    dest: "{{ current_backup_dir }}/BACKUP_REPORT.md"
    content: |
      # Backup Report

      **Timestamp:** {{ backup_timestamp }}
      **Mode:** 'BACKUP'

      ## Versions
      **Forgejo:** {{ forgejo_image | default('unknown') }}
      **PostgreSQL:** {{ postgres_image | default('unknown') }}

      ## Components Status

      | Component | Status | Details |
      |-----------|--------|--------|
      | PostgreSQL | {{ 'SUCCESS ✅' if postgres_backup_succeeded else 'FAILED ❌' }} | {{ postgres_backup_error | default('') if not postgres_backup_succeeded else '' }} |
      | Forgejo | {{ 'SUCCESS ✅' if forgejo_backup_succeeded else 'FAILED ❌' }} | {{ forgejo_backup_error | default('') if not forgejo_backup_succeeded else '' }} |
      | Project Setup | {{ 'SUCCESS ✅' if config_backup_succeeded|default(false) else 'FAILED ❌' }} | {{ config_backup_error | default('') if not config_backup_succeeded|default(false) else '' }} |

      ## Summary
      
      Overall backup status: {{ 'SUCCESS ✅' if backup_succeeded else 'FAILED ❌' }}
      {% if backup_failure_reason is defined and not backup_succeeded %}
      Error: {{ backup_failure_reason }}
      {% endif %}
    mode: '0644'
  when: postgres_backup_succeeded or forgejo_backup_succeeded or config_backup_succeeded|default(false)

#################################################
# Cleanup and Service Restoration
#################################################

- name: Notify Rollback services handler
  ansible.builtin.debug:
    msg: "Notifying Rollback services handler"
  when: backup_succeeded|bool and operation_mode != 'upgrade'
  changed_when: true
  notify: Rollback services
  
- name: Show final backup status
  vars:
    msg: |
      Backup {{ 'SUCCEEDED' if backup_succeeded else 'FAILED' }}.
      PostgreSQL: {{ 'OK' if postgres_backup_succeeded else 'FAILED' }}{% if postgres_backup_error is defined and not postgres_backup_succeeded %} ({{ postgres_backup_error }}){% endif %}.
      Forgejo: {{ 'OK' if forgejo_backup_succeeded else 'FAILED' }}{% if forgejo_backup_error is defined and not forgejo_backup_succeeded %} ({{ forgejo_backup_error }}){% endif %}.
      Project Setup: {{ 'OK' if config_backup_succeeded|default(false) else 'FAILED' }}{% if config_backup_error is defined and not config_backup_succeeded|default(false) %} ({{ config_backup_error }}){% endif %}.
      Services state will be ROLLED BACK.
  ansible.builtin.debug:
    msg: "{{ msg.split('\n') }}"
      
- name: Clean up backup files if backup failed
  ansible.builtin.file:
    path: "{{ current_backup_dir }}/{{ item }}"
    state: absent
  loop:
    - "{{ forgejo_backup_filename }}"
    - "{{ postgres_backup_filename }}"
  when: not backup_succeeded

- name: Fail task if backup failed
  ansible.builtin.fail:
    msg: "Backup failed: {{ backup_failure_reason|default('Unknown error') }}"
  when: not backup_succeeded