---
# Forgejo Service Check Tasks
#
# This file implements service verification functionality for Forgejo services using docker_host_info.
# It provides comprehensive container status checking and reporting without relying on configuration files.
#
# Key features:
# - Direct detection of running containers with project-specific labels
# - Comprehensive status information gathering for all managed containers
# - Detailed health and connectivity reporting
# - Service status summary with key metrics
# - Fact variables for reuse in other tasks and roles

#################################################
# Initialization and Setup
#################################################

- name: Check if Forgejo Rootless project source path is defined
  ansible.builtin.fail:
    msg: "Required variable 'forgejo_project_src' is not defined. Please specify the path to the Forgejo project directory."
  when: forgejo_project_src is not defined

#################################################
# Container Information Gathering
#################################################

- name: Gather Docker container information using docker_host_info
  community.docker.docker_host_info:
    containers: true
    verbose_output: true
    containers_filters:
      label:
        - com.docker.compose.project=forgejo-rootless
        - com.docker.compose.project.working_dir={{ forgejo_project_src }}
  register: docker_containers_info

- name: Verify services are exists
  ansible.builtin.assert:
    that:
      - docker_containers_info.containers | length > 0
    fail_msg: "No services found for project directory: {{ forgejo_project_src }}"
  
#################################################
# Process Container Information
#################################################

- name: Initialize container facts
  ansible.builtin.set_fact:
    services_facts: []

- name: Process container information
  ansible.builtin.set_fact:
    services_facts: >
      {{ services_facts | default([]) + [
          {
            'id': item.Id,
            'service': item.Labels['com.docker.compose.service'],
            'state': item.State,
            'health': (
              'healthy' if '(healthy)' in item.Status else
              'starting' if '(starting)' in item.Status else
              'unhealthy' if '(unhealthy)' in item.Status else
              ''
            ),
            'name': item.Names[0] | regex_replace('^/', ''),
            'status': item.Status,
            'uptime': item.Status | regex_search('Up ([^\\(]*)') | default('') | trim | default('Unknown'),
            'image': item.Image
          }
        ]
      }}
  loop: "{{ docker_containers_info.containers }}"
  loop_control:
    label: "{{ item.Labels['com.docker.compose.service'] }}"
  when: item.Labels['com.docker.compose.service'] is defined

#################################################
# Check Result Summary
#################################################

- name: Create check result summary
  ansible.builtin.set_fact:
    check_result_summary: |
      # Forgejo Service Status Report
      
      ## Summary
      - **Total Services**: {{ services_facts | length }}
      - **Project Directory**: {{ forgejo_project_src }}
      
      ## Detailed Container Status
      {% for service in services_facts %}
      ### {{ service.service | title }}
      - **Container ID**: {{ service.id | truncate(12, true, '') }}
      - **Container Name**: {{ service.name }}
      - **State**: {{ service.state }}
      - **Status**: {{ service.status }}
      - **Uptime**: {{ service.uptime }}
      - **Health**: {{ 
          service.health }}{{ service.health | ternary('', 'No health check') }}{{
          ' ✅' if service.health is search('healthy') else
          ' ⏳' if service.health is search('starting') else
          ' ❌' if service.health is search('unhealthy') else
          ''
        }}
      - **Image**: {{ service.image }}
      {% endfor %}
      
      Generated at {{ ansible_date_time.iso8601 }}
  when: services_facts|length > 0

#################################################
# Detailed Reporting
#################################################

- name: Display service status summary
  ansible.builtin.debug:
    msg: "{{ check_result_summary.split('\n') }}"
  when: check_result_summary is defined

- name: Generate service check metadata
  ansible.builtin.set_fact:
    check_result:
      timestamp: "{{ ansible_date_time.iso8601 }}"
      project_dir: "{{ forgejo_project_src }}"
      container_count: "{{ services_facts | length }}"
      services: "{{ services_facts }}"
  when: services_facts|length > 0