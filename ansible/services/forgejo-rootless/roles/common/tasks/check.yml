---
# Forgejo Service Check Tasks
#
# This file implements service verification functionality for Forgejo services using docker_host_info.
# It provides comprehensive container status checking and reporting without relying on configuration files.
#
# Key features:
# - Direct detection of running containers with project-specific labels
# - Comprehensive status information gathering for all managed containers
# - Detailed health and connectivity reporting
# - Service status summary with key metrics
# - Fact variables for reuse in other tasks and roles

#################################################
# Initialization and Setup
#################################################

- name: Verify forgejo project source path and bind mount paths are defined
  ansible.builtin.assert:
    that:
      - forgejo_project_src is defined
      - forgejo_data_dir is defined
      - forgejo_conf_dir is defined
      - postgres_data_dir is defined
    fail_msg: "Required variables are not defined. Please specify the paths to the Forgejo project directory and bind mount directories."
  
#################################################
# File and Directory Existence Checks
#################################################

- name: Gather docker-compose and bind mount files statistics
  ansible.builtin.stat:
    path: "{{ item.path }}"
  loop:
    - { id: "docker_compose",   path: "{{ forgejo_project_src }}/docker-compose.yml",   name: "Docker Compose File" }
    - { id: "project_secrets",  path: "{{ forgejo_project_src }}/secrets",              name: "Project Secrets Directory" }
    - { id: "forgejo_data",     path: "{{ forgejo_data_dir|trim }}",                    name: "Forgejo Data Directory" }
    - { id: "forgejo_config",   path: "{{ forgejo_conf_dir|trim }}",                    name: "Forgejo Configuration Directory" }
    - { id: "postgres_data",    path: "{{ postgres_data_dir|trim }}",                   name: "PostgreSQL Data Directory" }
  register: data_stats

#################################################
# Container Information Gathering
#################################################

- name: Gather Docker container information using docker_host_info
  community.docker.docker_host_info:
    containers: true
    verbose_output: true
    containers_filters:
      label:
        - com.docker.compose.project={{ project_name }}
        - com.docker.compose.project.working_dir={{ forgejo_project_src }}
  register: docker_containers_info

#################################################
# Process Container Information
#################################################

- name: Initialize container facts
  ansible.builtin.set_fact:
    services_facts: []

- name: Process container information
  ansible.builtin.set_fact:
    services_facts: >
      {{ services_facts | default([]) + [
          {
            'id': item.Id,
            'service': item.Labels['com.docker.compose.service'],
            'state': item.State,
            'health': (
              'healthy' if '(healthy)' in item.Status else
              'starting' if '(starting)' in item.Status else
              'unhealthy' if '(unhealthy)' in item.Status else
              ''
            ),
            'name': item.Names[0] | regex_replace('^/', ''),
            'status': item.Status,
            'uptime': item.Status | regex_search('Up ([^\\(]*)') | default('') | trim | default('Unknown'),
            'image': item.Image
          }
        ]
      }}
  loop: "{{ docker_containers_info.containers }}"
  loop_control:
    label: "{{ item.Labels['com.docker.compose.service'] }}"
  when: item.Labels['com.docker.compose.service'] is defined

#################################################
# Check Result Summary
#################################################
    
- name: Extract name, exists and path values from data stats results
  # https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_filters.html#combining-items-from-multiple-lists-zip-and-zip-longest
  ansible.builtin.set_fact:
    file_stats_values: "{{ data_stats.results | map(attribute='stat.exists') | zip(data_stats.results | map(attribute='item.path'), data_stats.results | map(attribute='item.name')) | list }}"
    
- name: Convert file stats array to list of dictionaries
  # https://docs.ansible.com/ansible/latest/collections/community/general/dict_filter.html#examples
  ansible.builtin.set_fact:
    file_check_stats: "{{ file_stats_values | map('zip', ['exists', 'path', 'name']) | map('map', 'reverse') | map('community.general.dict') | list }}"
    
- name: Prepare file stats key list
  ansible.builtin.set_fact:
    file_check_stats_keys: "{{ data_stats.results | map(attribute='item.id') | list }}"
    
- name: Create file check results
  ansible.builtin.set_fact:
    file_check_stats: "{{ dict(file_check_stats_keys | zip(file_check_stats)) }}"
    
- name: Create check result summary
  ansible.builtin.set_fact:
    check_result_summary: |
      # Forgejo Service Status Report
      
      ## Summary
      - **Total Services**: {{ services_facts | length }}
      - **Project Name**: {{ project_name }}
      - **Project Directory**: {{ forgejo_project_src }}

      ## File System Checks
      {% for key in file_check_stats.keys() %}
      - **{{ file_check_stats[key].name }}**: {{ 'Exists ✅' if file_check_stats[key].exists else 'Missing ❌' }}
      {% endfor %}
      
      ## Detailed Container Status
      {% for service in services_facts %}
      ### {{ service.service | title }}
      - **Container ID**: {{ service.id | truncate(12, true, '') }}
      - **Container Name**: {{ service.name }}
      - **State**: {{ service.state }}
      - **Status**: {{ service.status }}
      - **Uptime**: {{ service.uptime }}
      - **Health**: {{ 
          service.health }}{{ service.health | ternary('', 'No health check') }}{{
          ' ✅' if service.health is search('healthy') else
          ' ⏳' if service.health is search('starting') else
          ' ❌' if service.health is search('unhealthy') else
          ''
        }}
      - **Image**: {{ service.image }}
      {% endfor %}
      
      Generated at {{ ansible_date_time.iso8601 }}
  when: services_facts|length > 0

#################################################
# Detailed Reporting
#################################################

- name: Display service status summary
  ansible.builtin.debug:
    msg: "{{ check_result_summary.split('\n') }}"
  when: check_result_summary is defined

- name: Generate service check metadata
  ansible.builtin.set_fact:
    check_result:
      timestamp: "{{ ansible_date_time.iso8601 }}"
      project_src: "{{ forgejo_project_src }}"
      file_check_stats: "{{ file_check_stats }}"
      container_count: "{{ services_facts | length }}"
      services: "{{ services_facts }}"