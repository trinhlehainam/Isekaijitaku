---
# Forgejo and PostgreSQL Restore Tasks
# 
# This file implements a restore strategy using Docker's native commands for Forgejo and PostgreSQL.
# Key concepts:
# - Checks if backup files exist before restoration
# - Stops all services before restoration begins
# - Removes current data directories to avoid conflicts
# - Restores PostgreSQL database from dump file
# - Unzips and restores Forgejo application data
# - Starts services once restoration is complete
# - Generates detailed restoration report

#################################################
# Initialization and Setup
#################################################

- name: Set up project source path variable 
  ansible.builtin.set_fact:
    forgejo_project_src: "{{ forgejo_project_src|default(ansible_user_dir + '/Docker/forgejo-rootless') }}"
    
- name: Set up backup directory variable
  ansible.builtin.set_fact:
    forgejo_backup_dir: "{{ forgejo_backup_dir|default(forgejo_project_src + '/backups') }}"

- name: Gather backup directory information
  ansible.builtin.stat:
    path: "{{ forgejo_backup_dir }}"
  register: backup_dir_stat

- name: Fail if backup directory doesn't exist
  ansible.builtin.fail:
    msg: "Backup directory {{ forgejo_backup_dir }} doesn't exist or is not a directory"
  when: not backup_dir_stat.stat.exists or not backup_dir_stat.stat.isdir

- name: Find most recent backup directory
  ansible.builtin.find:
    paths: "{{ forgejo_backup_dir }}"
    file_type: directory
    patterns: "*-*-*_*-*"
  register: timestamp_dirs

- name: Sort timestamp directories by modification time
  ansible.builtin.set_fact:
    sorted_backup_dirs: "{{ timestamp_dirs.files | sort(attribute='mtime', reverse=true) }}"

- name: Fail if no timestamp backup directories found
  ansible.builtin.fail:
    msg: "No backup directories found in {{ forgejo_backup_dir }}."
  when: sorted_backup_dirs|length == 0

- name: Set latest backup directory
  ansible.builtin.set_fact:
    current_backup_dir: "{{ sorted_backup_dirs[0].path }}"

- name: Check if backup directory exists
  ansible.builtin.stat:
    path: "{{ current_backup_dir }}"
  register: backup_dir_stat

- name: Fail if backup directory doesn't exist
  ansible.builtin.fail:
    msg: "Backup directory {{ current_backup_dir }} doesn't exist or is not a directory"
  when: not backup_dir_stat.stat.exists or not backup_dir_stat.stat.isdir

- name: Set up restoration variables
  ansible.builtin.set_fact:
    restore_timestamp: "{{ lookup('pipe', 'date +%Y-%m-%d_%H-%M') }}"
    restore_succeeded: false
    postgres_restore_succeeded: false
    postgres_backup_filename: "forgejo-db-backup.dump"
    forgejo_restore_succeeded: false
    forgejo_backup_filename: "forgejo-app-dump.zip"

- name: Check if PostgreSQL backup file exists
  ansible.builtin.stat:
    path: "{{ current_backup_dir }}/{{ postgres_backup_filename }}"
  register: postgres_backup_file

- name: Check if Forgejo backup file exists
  ansible.builtin.stat:
    path: "{{ current_backup_dir }}/{{ forgejo_backup_filename }}"
  register: forgejo_backup_file

- name: Verify both backup files exist
  ansible.builtin.fail:
    msg: "No backup files found in {{ current_backup_dir }}. Expected files: {{ postgres_backup_filename }}, {{ forgejo_backup_filename }}"
  when: not (postgres_backup_file.stat.exists and forgejo_backup_file.stat.exists)

#################################################
# Services Management
#################################################

- name: Check services status
  ansible.builtin.include_tasks: check.yml

- name: Make sure services are down before restore
  community.docker.docker_compose_v2:
    project_src: "{{ forgejo_project_src }}"
    services: "{{ item.service }}"
    state: absent
  loop: "{{ check_result.services }}"
  loop_control:
    label: "{{ item.service }}"

- name: Set restore directory variable
  ansible.builtin.set_fact:
    current_restore_dir: "{{ current_backup_dir }}/restore"

- name: Check forgejo bind mount variables
  ansible.builtin.set_fact:
    forgejo_data_dir: "{{ forgejo_data_dir if forgejo_data_dir is defined and (forgejo_data_dir.startswith('/') or forgejo_data_dir.startswith('./')) else forgejo_project_src + '/data' }}"
    forgejo_conf_dir: "{{ forgejo_conf_dir if forgejo_conf_dir is defined and (forgejo_conf_dir.startswith('/') or forgejo_conf_dir.startswith('./')) else forgejo_project_src + '/conf' }}"
    postgres_data_dir: "{{ postgres_data_dir if postgres_data_dir is defined and (postgres_data_dir.startswith('/') or postgres_data_dir.startswith('./')) else forgejo_project_src + '/postgres' }}"

- name: Create restore workspace directory
  ansible.builtin.file:
    path: "{{ current_restore_dir }}"
    state: directory
    mode: '0755'

- name: Remove current data directories
  become: true
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop:
    - { path: "{{ forgejo_data_dir }}" }
    - { path: "{{ forgejo_conf_dir }}" }
    - { path: "{{ postgres_data_dir }}" }

#################################################
# Forgejo Application Data Restore
#################################################

- name: Restore Forgejo application data
  block:
    - name: Create temp directory for unzipping
      ansible.builtin.file:
        path: "{{ current_restore_dir }}/temp"
        state: directory
        mode: '0755'
      register: temp_unzip_dir
      when: forgejo_backup_file.stat.exists

    - name: Unzip Forgejo backup to temp directory
      ansible.builtin.unarchive:
        src: "{{ forgejo_backup_file.stat.path }}"
        dest: "{{ current_restore_dir }}/temp"
        remote_src: true
      register: unzip_result
      when: forgejo_backup_file.stat.exists

    - name: Ensure Forgejo data directories exist and have proper ownership
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        mode: '0755'
        owner: "{{ forgejo_user_id }}"
        group: "{{ forgejo_group_id }}"
      loop:
        - { path: "{{ forgejo_conf_dir }}" }
        - { path: "{{ forgejo_data_dir }}" }

    - name: Setup Forgejo restore item variables
      ansible.builtin.set_fact:
        forgejo_restore_items:
          - src: "{{ current_restore_dir }}/temp/app.ini"
            dest: "{{ forgejo_conf_dir }}/app.ini"
            required: true
          - src: "{{ current_restore_dir }}/temp/repos"
            dest: "{{ forgejo_data_dir }}/git/repositories/"
            required: true
          - src: "{{ current_restore_dir }}/temp/data"
            dest: "{{ forgejo_data_dir }}"
            required: true
          - src: "{{ current_restore_dir }}/temp/log"
            dest: "{{ forgejo_data_dir }}/data/log"
            required: false
          
    - name: Check Forgejo restore items
      ansible.builtin.stat:
        path: "{{ item.src }}"
      loop: "{{ forgejo_restore_items }}"
      loop_control:
        label: "{{ item.src }}"
      when: unzip_result is success
      register: item_stats
      
    - name: Build update list for item restore stats
      ansible.builtin.set_fact:
        update_list: "{{ update_list + update }}"
      loop: "{{ forgejo_restore_items }}"
      loop_control:
        index_var: idx
      vars:
        update_list: []
        item_stat: "{{ item_stats.results | selectattr('item.src', '==', item.src) | first }}"
        update:
          - path: forgejo_restore_items[{{ idx }}].exists
            value: "{{ item_stat.stat.exists if item_stat is defined else false }}"
            
    - name: Make the Frogejo restore items update list
      # https://docs.ansible.com/ansible/latest/collections/ansible/utils/update_fact_module.html
      ansible.utils.update_fact:
        updates: "{{ update_list }}"
      register: updated_result
      
    - name: Verify update result
      ansible.builtin.assert:
        that: "updated_result.failed == false"
        fail_msg: "Failed to update Forgejo restore items"
        success_msg: "Successfully updated Forgejo restore items"

    - name: Update Forgejo restore items
      ansible.builtin.set_fact:
        forgejo_restore_items: "{{ updated_result.forgejo_restore_items }}"
        
    - name: Verify required items exist
      vars:
        missing_required_items: "{{ forgejo_restore_items | selectattr('required', '==', true) | selectattr('exists', '==', false) }}"
      ansible.builtin.assert:
        that: 
          - "missing_required_items | length == 0"
        fail_msg: "Required items missing: {{ missing_required_items | map(attribute='src') | join(', ') }}"
        success_msg: "All required items for Forgejo restoration are available"

    - name: Copy Forgejo restore items
      ansible.builtin.copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: "{{ forgejo_user_id }}"
        group: "{{ forgejo_group_id }}"
        remote_src: true
      loop: "{{ forgejo_restore_items }}"
      when: item.exists

    - name: Mark Forgejo restoration as successful
      ansible.builtin.set_fact:
        forgejo_restore_succeeded: true

  rescue:
    - name: Record Forgejo restoration failure
      ansible.builtin.set_fact:
        forgejo_restore_error: "{{ ansible_failed_result.msg | default('Unknown error during Forgejo restoration') }}"
        restore_failure_reason: "Forgejo restoration failed: {{ ansible_failed_result.msg | default('Unknown error') }}"

#################################################
# PostgreSQL Database Restore
#################################################

- name: Restore PostgreSQL database
  block:
    - name: Start PostgreSQL container for restoration
      community.docker.docker_compose_v2:
        project_src: "{{ forgejo_project_src }}"
        services: forgejo-db
        state: present
      register: postgres_start_result
      when: postgres_backup_file.stat.exists

    - name: Get PostgreSQL container ID
      ansible.builtin.set_fact:
        postgres_container_id: "{{ (postgres_start_result.containers | selectattr('Service', '==', 'forgejo-db') | first).ID }}"
      when: postgres_start_result is success

    - name: Wait for PostgreSQL to be running and healthy
      when: postgres_container_id is defined
      community.docker.docker_container_info:
        name: "{{ postgres_container_id }}"
      register: postgres_container_info
      failed_when: not postgres_container_info.container.State.Running or postgres_container_info.container.State.Health.Status == 'unhealthy'
      until: postgres_container_info.container.State.Running and postgres_container_info.container.State.Health.Status == 'healthy'
      delay: 5
      retries: 5

    - name: Set PostgreSQL container restore filepath
      ansible.builtin.set_fact:
        postgres_backup_filepath: "{{ current_backup_dir }}/{{ postgres_backup_filename }}"

    - name: Verify restore file exists
      ansible.builtin.stat:
        path: "{{ postgres_backup_filepath }}"
      register: postgres_backup_file_stat

    - name: Restore backup file into PostgreSQL container
      community.docker.docker_compose_v2_exec:
        project_src: "{{ forgejo_project_src }}"
        service: forgejo-db
        command: pg_restore -U {{ db_user }} -d {{ db_name }} < {{ postgres_backup_filepath }}
        tty: false
      register: postgres_restore_result
      when: postgres_backup_file_stat.stat.exists
      
    - name: Debug PostgreSQL restore result
      ansible.builtin.debug:
        var: postgres_restore_result

    - name: Mark PostgreSQL restoration as successful
      ansible.builtin.set_fact:
        postgres_restore_succeeded: true
      when:
        - postgres_restore_result is defined
        - postgres_restore_result is success or (postgres_restore_result is failed and postgres_restore_result.stderr is regex('ERROR:  database ".*" does not exist'))

  rescue:
    - name: Record PostgreSQL restoration failure
      ansible.builtin.set_fact:
        postgres_restore_error: "{{ ansible_failed_result.msg | default('Unknown error during PostgreSQL restoration') }}"
        restore_failure_reason: "PostgreSQL restoration failed: {{ ansible_failed_result.msg | default('Unknown error') }}"

#################################################
# Restoration Status and Reporting
#################################################

- name: Set overall restoration success status
  ansible.builtin.set_fact:
    restore_report_path: "{{ current_backup_dir }}/restore/RESTORE_REPORT_{{ restore_timestamp }}.md"
    restore_succeeded: "{{ ((postgres_backup_file.stat.exists and postgres_restore_succeeded) or not postgres_backup_file.stat.exists) and ((forgejo_backup_file.stat.exists and forgejo_restore_succeeded) or not forgejo_backup_file.stat.exists) }}"

- name: Create restoration report
  ansible.builtin.copy:
    dest: "{{ restore_report_path }}"
    content: |
      # Forgejo Restoration Report

      **Timestamp:** {{ restore_timestamp }}
      **Backup Source:** {{ current_backup_dir }}
      **Project Directory:** {{ forgejo_project_src }}

      ## Components Status

      | Component | Status | Details |
      |-----------|--------|---------|
      | PostgreSQL | {{ 'SUCCESS ✅' if postgres_restore_succeeded else 'FAILED ❌' }} | {{ postgres_restore_error | default('') if not postgres_restore_succeeded else '' }} |
      | Forgejo | {{ 'SUCCESS ✅' if forgejo_restore_succeeded else 'FAILED ❌' }} | {{ forgejo_restore_error | default('') if not forgejo_restore_succeeded else '' }} |

      ## Restored Files Information

      | Component | Source Path | Destination Path | Status |
      |-----------|------------|-----------------|--------|
      {% for item in forgejo_restore_items %}
      | {{ item.src | basename }} | {{ item.src }} | {{ item.dest }} | {{ 'RESTORED ✅' if item.exists else 'MISSING ❌' }} |
      {% endfor %}

      ## Summary

      Overall restoration status: {{ 'SUCCESS ✅' if restore_succeeded else 'FAILED ❌' }}
      {% if restore_failure_reason is defined and not restore_succeeded %}
      Error: {{ restore_failure_reason }}
      {% endif %}

      Services will be {{ 'started' if restore_succeeded else 'left down' }} after restoration.
    mode: '0644'

#################################################
# Post-restore Service Management
#################################################

- name: Start and wait for services to be running and healthy
  ansible.builtin.include_tasks: start.yml
  when: restore_succeeded

- name: Display success message
  ansible.builtin.debug:
    msg: |
      Forgejo has been successfully restored from backup.
      Restoration report saved to {{ restore_report_path }}
  when: restore_succeeded

- name: Build full error message
  ansible.builtin.set_fact:
    error_msg: |
      Forgejo restoration failed!
      Restoration report saved to {{ restore_report_path }}
      Error: {{ restore_failure_reason|default('Unknown error') }}
  when: not restore_succeeded

- name: Fail when restoration is unsuccessful
  ansible.builtin.fail:
    msg: "{{ error_msg }}"
  when: error_msg is defined

- name: Clean up temporary restore folders
  ansible.builtin.file:
    path: "{{ current_backup_dir }}/restore/temp"
    state: absent
  when: restore_succeeded
