---
# Forgejo Rootless Main Entry Point
# This file determines which tasks to include based on operation mode

- name: Set up service project source path
  ansible.builtin.set_fact:
    service_project_src: "{{ service_project_src|default(ansible_user_dir + '/Docker/forgejo-rootless') }}"

- name: Check service bind mount variables
  ansible.builtin.set_fact:
    forgejo_data_dir: "{{ forgejo_data_dir if forgejo_data_dir is defined and (forgejo_data_dir.startswith('/') or forgejo_data_dir.startswith('./')) else './data' }}"
    forgejo_conf_dir: "{{ forgejo_conf_dir if forgejo_conf_dir is defined and (forgejo_conf_dir.startswith('/') or forgejo_conf_dir.startswith('./')) else './conf' }}"
    postgres_data_dir: "{{ postgres_data_dir if postgres_data_dir is defined and (postgres_data_dir.startswith('/') or postgres_data_dir.startswith('./')) else './postgres' }}"

- name: Resolve service bind mount from relative paths to absolute paths
  ansible.builtin.set_fact:
    forgejo_data_dir: "{{ forgejo_data_dir.replace('./', service_project_src + '/') }}"
    forgejo_conf_dir: "{{ forgejo_conf_dir.replace('./', service_project_src + '/') }}"
    postgres_data_dir: "{{ postgres_data_dir.replace('./', service_project_src + '/') }}"

- name: Set default operation mode if not defined
  ansible.builtin.set_fact:
    operation_mode: "{{ operation_mode | default('check') }}"

- name: Include check tasks
  ansible.builtin.include_tasks: check.yml
  when: operation_mode == 'check'

- name: Include deploy tasks
  ansible.builtin.include_tasks: deploy.yml
  when: operation_mode == 'deploy'

- name: Include backup tasks
  ansible.builtin.include_tasks: backup.yml
  when: operation_mode == 'backup' 

- name: Include restore tasks
  ansible.builtin.include_tasks: restore.yml
  when: operation_mode == 'restore'

- name: Include upgrade tasks
  ansible.builtin.include_tasks: upgrade.yml
  when: operation_mode == 'upgrade'

- name: Include repository creation tasks
  ansible.builtin.include_tasks: create_repo.yml
  when: operation_mode == 'create_repo'