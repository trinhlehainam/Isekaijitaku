---
######################################################################
# SETUP - Initialize variables and create required directories
######################################################################

- name: Create required directories
  block:
    - name: Create directory for docker-compose files
      ansible.builtin.file:
        path: "{{ service_project_src }}"
        state: directory
        mode: '0755'

    - name: Create secrets directory for storing sensitive information
      ansible.builtin.file:
        path: "{{ service_project_src }}/secrets"
        state: directory
        mode: '0700'

- name: Resolve directory paths
  block:
    - name: Set resolved data directory path
      ansible.builtin.set_fact:
        resolved_data_dir: >-
          {% if forgejo_data_dir.startswith('/') %}
          {{ forgejo_data_dir }}
          {% elif forgejo_data_dir.startswith('./') %}
          {{ service_project_src }}/{{ forgejo_data_dir|regex_replace('^\.\/', '') }}
          {% else %}
          {{ service_project_src }}/data
          {% endif %}

    - name: Set resolved conf directory path
      ansible.builtin.set_fact:
        resolved_conf_dir: >-
          {% if forgejo_conf_dir.startswith('/') %}
          {{ forgejo_conf_dir }}
          {% elif forgejo_conf_dir.startswith('./') %}
          {{ service_project_src }}/{{ forgejo_conf_dir|regex_replace('^\.\/', '') }}
          {% else %}
          {{ service_project_src }}/conf
          {% endif %}
          
    - name: Trim resolved directory variables
      ansible.builtin.set_fact:
        resolved_data_dir: "{{ resolved_data_dir|trim }}"
        resolved_conf_dir: "{{ resolved_conf_dir|trim }}"

- name: Create and set ownership for application directories
  block:
    - name: Create and set ownership for Forgejo data directory
      become: true
      ansible.builtin.file:
        path: "{{ resolved_data_dir }}"
        state: directory
        mode: '0755'
        owner: "{{ forgejo_user_id }}"
        group: "{{ forgejo_group_id }}"
        
    - name: Create and set ownership for Forgejo config directory
      become: true
      ansible.builtin.file:
        path: "{{ resolved_conf_dir }}"
        state: directory
        mode: '0755'
        owner: "{{ forgejo_user_id }}"
        group: "{{ forgejo_group_id }}"

######################################################################
# CONFIGURATION - Prepare service configuration and secrets
######################################################################

- name: Set up Docker network and secrets
  block:
    - name: Ensure runner docker network exists
      community.docker.docker_network:
        name: runner
        state: present

    - name: Create PostgreSQL database password file
      ansible.builtin.copy:
        content: "{{ db_password }}"
        dest: "{{ service_project_src }}/secrets/db_password"
        mode: '0600'

- name: Configure optional services
  block:
    - name: Check Forgejo mailer variables
      ansible.builtin.set_fact:
        use_forgejo_mailer: >-
          {{ True if forgejo_mailer_smtp_port is defined 
          and forgejo_mailer_smtp_addr is defined 
          and forgejo_mailer_user is defined 
          and forgejo_mailer_password is defined 
          else False }}

    - name: Create mailer password file if mailer is configured
      ansible.builtin.copy:
        content: "{{ forgejo_mailer_password }}"
        dest: "{{ service_project_src }}/secrets/mailer_password"
        mode: '0600'
      when: use_forgejo_mailer|bool and forgejo_mailer_password is defined
      
    - name: Check Forgejo admin user creation variables
      ansible.builtin.set_fact:
        use_forgejo_install_lock: >-
          {{ True if forgejo_admin_username is defined 
          and forgejo_admin_email is defined 
          and forgejo_admin_password is defined 
          else False }}

######################################################################
# DEPLOYMENT - Start and verify services
######################################################################

- name: Deploy Forgejo services
  block:
    - name: Copy docker-compose file
      ansible.builtin.template:
        src: "docker-compose.yml.j2"
        dest: "{{ service_project_src }}/docker-compose.yml"
        mode: '0644'

    - name: Start and wait for services to be running and healthy
      ansible.builtin.include_tasks: start.yml
  
######################################################################
# POST-DEPLOYMENT - Set up initial admin user if configured
######################################################################

- name: Check and create Forgejo admin user when install lock is enabled
  when: use_forgejo_install_lock|bool
  block:
    - name: Check Forgejo admin user creation
      community.docker.docker_compose_v2_exec:
        project_src: "{{ service_project_src }}"
        service: forgejo
        # https://forgejo.org/docs/latest/admin/command-line/#admin-user-list
        command: forgejo admin user list --admin
      changed_when: false
      register: admin_user_info
      
    - name: Create Forgejo admin user
      when: not admin_user_info.stdout is search(forgejo_admin_username)
      community.docker.docker_compose_v2_exec:
        project_src: "{{ service_project_src }}"
        service: forgejo
        # https://forgejo.org/docs/latest/admin/command-line/#admin-user-create
        command: forgejo admin user create --admin --username {{ forgejo_admin_username }} --email {{ forgejo_admin_email }} --password {{ forgejo_admin_password }}
      changed_when: false
      register: create_admin_result

    - name: Verify admin user creation
      when: create_admin_result.skipped is not defined or not create_admin_result.skipped
      ansible.builtin.assert:
        that:
          - create_admin_result.rc == 0
          # https://stackoverflow.com/a/52112477
          - create_admin_result.stdout is search("successfully created")
        fail_msg: "Failed to create admin user: {{ create_admin_result.stderr }}"