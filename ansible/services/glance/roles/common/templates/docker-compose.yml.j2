# https://github.com/glanceapp/docker-compose-template/blob/main/root/docker-compose.yml

name: {{ project_name }}
services:
  glance:
    container_name: glance
    # https://hub.docker.com/r/glanceapp/glance/tags
    image: "glanceapp/glance:v0.7.13"
    restart: unless-stopped
    volumes:
      - {{ glance_config_dir }}:/app/config
      - {{ glance_assets_dir }}:/app/assets
{% if use_local_dns|default(false) and local_dns|default(false) %}
    dns:
      - {{ local_dns }}
      - 1.1.1.1
      - 1.0.0.1
{% endif %}
{% if not use_traefik|default(false) %}
    ports:
      - 8080:8080
{% endif %}
{% if use_traefik|default(false) %}
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - 'traefik.docker.network=proxy'
      - 'traefik.http.services.glance.loadbalancer.server.port=80'
  {% if use_traefik_router_private|default(false) and private_apex_domain|default(false) %}
      ## Private
      - "traefik.http.routers.glance-local.rule=Host(`{{ service_name|default('glance') }}.{{ private_apex_domain }}`)"
      - "traefik.http.routers.glance-local.entrypoints=websecure"
      - "traefik.http.routers.glance-local.tls.certresolver=stepca"
      - "traefik.http.routers.glance-local.middlewares=oauth2-admin@file"
  {% endif %}
  {% if use_traefik_router_public|default(false) and public_apex_domain|default(false) %}
      ## Public
      - "traefik.http.routers.glance.rule=Host(`{{ service_name|default('glance') }}.{{ public_apex_domain }}`)"
      - "traefik.http.routers.glance.entrypoints=websecure"
      - "traefik.http.routers.glance.tls.certresolver=cloudflare"
      - "traefik.http.routers.glance.middlewares=oauth2-admin@file"
  {% endif %}

networks:
  proxy:
    external: true
{% endif %}