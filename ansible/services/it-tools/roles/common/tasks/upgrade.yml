##############################################################################
# Initialization
##############################################################################

- name: Set upgrade start time
  ansible.builtin.set_fact:
    upgrade_start_time: "{{ ansible_date_time.iso8601_basic_short }}"
    backup_timestamp: "{{ lookup('pipe', 'date +%Y-%m-%d_%H-%M') }}"
    upgrade_success: false # Initialize upgrade success flag

##############################################################################
# Current Version Analysis
##############################################################################

- name: Check current {{ project_name|upper }} container status
  vars:
    project_src: "{{ service_project_src }}"
  ansible.builtin.include_tasks: check.yml
  
- name: Extract current running {{ project_name|upper }} image information
  ansible.builtin.set_fact:
    current_service: "{{ check_result.services | selectattr('service', 'equalto', 'it-tools') | first }}"
  when: check_result.services | selectattr('service', 'equalto', 'it-tools') | length > 0

- name: Define docker-compose path
  ansible.builtin.set_fact:
    compose_file_path: "{{ service_project_src }}/docker-compose.yml"

- name: Check if target docker-compose file exists
  ansible.builtin.stat:
    path: "{{ compose_file_path }}"
  register: compose_file_stat

- name: Verify {{ project_name|upper }} service information is available
  ansible.builtin.assert:
    that:
      - current_service is defined
      - compose_file_stat.stat.exists
    fail_msg: "Unable to find {{ project_name|upper }} service information in the check results."
    
- name: Get current docker-compose content
  ansible.builtin.slurp:
    path: "{{ compose_file_path }}"
  register: current_docker_compose

- name: Extract current {{ project_name|upper }} version using regex
  ansible.builtin.set_fact:
    current_image_match: "{{ (current_docker_compose.content | b64decode | from_yaml).services['it-tools'].image | regex_search('^\"?(?P<depName>[^\\s:@\"]+)(?::(?P<currentValue>[-a-zA-Z0-9.]+))?(?:@(?P<currentDigest>sha256:[a-zA-Z0-9]+))?\"?$', '\\1', '\\2', '\\3') }}"
    current_image_tag: omit # Explicitly omit first
  when: current_docker_compose is defined and current_docker_compose.content is defined

- name: Set image tag from regex match if found
  ansible.builtin.set_fact:
    current_image_name: "{{ current_image_match[0] }}"
    current_image_tag: "{{ current_image_match[1] }}"
  when:
    - current_image_match is defined
    - current_image_match[0] is defined
    - current_image_match[1] is defined and current_image_match[1] != 'latest'

- name: Check if current image tag is missing and fail
  when: current_image_tag == omit
  ansible.builtin.fail:
    msg: "ERROR: Cannot determine the current image tag for '{{ current_service.image }}'. Please ensure the running service uses an explicit, non-latest version tag (e.g., 'kopia/kopia:0.19.0') before attempting an upgrade. Upgrade aborted for this host."

##############################################################################
# Compare Versions and Determine if Upgrade is Needed
##############################################################################

- name: Set target image details
  ansible.builtin.set_fact:
    target_image: "{{ (lookup('template', 'docker-compose.yml.j2') | from_yaml).services['it-tools'].image }}"

- name: Initialize version comparison flags
  ansible.builtin.set_fact:
    target_image_match: "{{ target_image | regex_search('^\"?(?P<depName>[^\\s:@\"]+)(?::(?P<currentValue>[-a-zA-Z0-9.]+))?(?:@(?P<currentDigest>sha256:[a-zA-Z0-9]+))?\"?$', '\\1', '\\2', '\\3')}}"
    upgrade_needed: false
    target_image_tag: omit

- name: Set image tag from regex match if found
  ansible.builtin.set_fact:
    target_image_name: "{{ target_image_match[0] }}"
    target_image_tag: "{{ target_image_match[1] }}"
  when:
    - target_image_match is defined
    - target_image_match[0] is defined
    - target_image_match[1] is defined and target_image_match[1] != 'latest'

- name: Clean current version string for comparison
  ansible.builtin.set_fact:
    current_version_clean: "{{ current_image_tag | regex_replace('^v?((?:\\d+\\.){0,2}\\d+).*$', '\\1') }}"
  when: current_image_tag != omit

- name: Clean target version string for comparison
  ansible.builtin.set_fact:
    target_version_clean: "{{ target_image_tag | regex_replace('^v?((?:\\d+\\.){0,2}\\d+).*$', '\\1') }}"
  when: target_image_tag != omit

- name: Set final upgrade needed flag based on tag change or version comparison
  ansible.builtin.set_fact:
    upgrade_needed: "{{ target_version_clean is version(current_version_clean, '>') }}"

##############################################################################
# Upgrade Process (Using Replace Module)
##############################################################################

- name: Perform Upgrade and Verification Steps
  when: upgrade_needed
  block:
    - name: Replace image tag in docker-compose file
      ansible.builtin.replace:
        path: "{{ compose_file_path }}"
        regexp: "{{ current_image_tag }}"
        replace: "{{ target_image_tag }}"
        backup: true # Automatically creates backup
      register: replace_result

    - name: Pull updated images (only if replace made a change)
      community.docker.docker_compose_v2_pull:
        project_src: "{{ service_project_src }}"
      when: replace_result.changed
      register: pull_result

    - name: Start services with new docker-compose configuration (only if pulled)
      ansible.builtin.include_tasks: start.yml

    - name: Extract current running {{ project_name|upper }} image information
      ansible.builtin.set_fact:
        current_service: "{{ check_result.services | selectattr('service', 'equalto', 'it-tools') | first }}"
      when: check_result.services | selectattr('service', 'equalto', 'it-tools') | length > 0

    - name: Verify container is running with the target version (only if checked)
      ansible.builtin.assert:
        that:
          - current_service is defined
          - current_service.state == 'running'
          - current_service.image is search(target_image_tag)
        fail_msg: |
          Service it-tools failed to reach healthy state after upgrade or new version '{{ target_image_tag }}' was not applied correctly.
          Container State: {{ current_service.state|default('Unknown') }}
          Expected Image Tag: {{ target_image_tag }}
          Actual Image: {{ current_service.image|default('Not Found') }}
      when: current_service is defined

    - name: Set upgrade success flag
      ansible.builtin.set_fact:
        upgrade_success: true
      when: replace_result.changed # Only successful if a change was attempted

  rescue:
    - name: Restore docker-compose from backup if replace occurred
      when: replace_result is defined and replace_result.changed and replace_result.backup_file is defined and replace_result.backup_file
      block:
        - name: Check if backup file exists
          ansible.builtin.stat:
            path: "{{ replace_result.backup_file }}"
          register: restore_backup_stat

        - name: Restore docker-compose from replace backup
          ansible.builtin.command:
            cmd: "mv {{ replace_result.backup_file }} {{ compose_file_path }}"
          when: restore_backup_stat.stat.exists
          register: restore_backup_result

        - name: Start services with original docker-compose configuration after restore
          ansible.builtin.include_tasks: start.yml
          when: restore_backup_result is defined and restore_backup_result.rc == 0

    - name: Fail the playbook after rescue attempt
      ansible.builtin.fail:
        msg: "Upgrade failed for {{ project_name }}. Attempted rollback. See previous logs for details."

##############################################################################
# Cleanup
##############################################################################

- name: Clean up backup docker compose file created by replace module
  ansible.builtin.file:
    path: "{{ replace_result.backup_file }}"
    state: absent
  when:
    - upgrade_success
    - replace_result is defined
    - replace_result.changed | default(false)
    - replace_result.backup_file is defined
    - replace_result.backup_file

##############################################################################
# Final Report
##############################################################################

- name: Final Upgrade Status Report
  ansible.builtin.debug:
    msg:
      - "Initial Version: {{ current_image_name }}:{{ current_image_tag }}"
      - "Target Version: {{ target_image_name }}:{{ target_image_tag }}"
      - "Upgrade Attempted: {{ 'Yes' if upgrade_needed else 'No (Not Required)' }}"
      - "Upgrade Successful: {{ upgrade_success if upgrade_success|default(false) else 'N/A' }}"
  when: upgrade_needed # Only show summary if an upgrade was attempted or considered

- name: Display skip message when no upgrade needed
  ansible.builtin.debug:
    msg: "{{ project_name | upper }} upgrade skipped on {{ inventory_hostname }}: Current version '{{ current_image_tag }}' is already the target version '{{ target_image_tag }}' or newer."
  when: not upgrade_needed