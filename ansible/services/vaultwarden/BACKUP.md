---
aliases:
  - "Vaultwarden Backup Process"
tags:
  - manifest
---

# Vaultwarden Backup Process

This document outlines the automated backup strategy for the Vaultwarden service, ensuring the preservation of both the database and critical application files.

## Prerequisites and Configuration

The successful execution of the backup requires the following variables defined within the Ansible inventory:

*   **`vaultwarden_backup_dir`**: Specifies the base directory on the target host where temporary files (like the database dump) are stored and serves as the source for the Kopia file snapshot.
    *   Its path is resolved relative to the service's project source (`service_project_src`) if starting with `./`, used absolutely if starting with `/`, or defaults to `./vaultwarden/data` relative to `service_project_src` otherwise.
*   **`kopia_backup_data_dir`**: Defines the root directory within the Kopia repository where service-specific data will be stored.
*   **`postgres_user`**: The PostgreSQL username used for connecting to the database.
*   **`postgres_db`**: The name of the Vaultwarden PostgreSQL database.

## Backup Components and Scope

This backup process combines two distinct methods to capture all necessary data for a full restore:

1.  **PostgreSQL Database Dump**: A complete logical backup of the Vaultwarden database (identified by `postgres_db`) is created using `pg_dump`. This file contains all core vault data, user information, configurations, and organization details stored in the database tables.
2.  **Kopia File Snapshot**: A snapshot of essential files within the Vaultwarden application data directory (`vaultwarden_backup_dir`) is taken using Kopia. This captures critical application data not stored within the database itself.

## Kopia Specifics

This section details the configuration and scope for the Kopia file snapshot component.

**Source Path:**
Kopia targets the resolved Vaultwarden application data directory (derived from `vaultwarden_backup_dir`). This path is typically `/path/to/vaultwarden/data` or similar.
**Important:** Kopia does *not* directly back up the live PostgreSQL data volume (e.g., `/var/lib/postgresql/data`). Database integrity is handled by the separate `pg_dump` process.

**Included Files:**
The Kopia snapshot intentionally includes the following essential files and directories found within the source path:

*   **`attachments/` (Required):** Contains all user-uploaded file attachments.
*   **`sends/` (Recommended):** Holds files associated with the Vaultwarden Send feature.
*   **`config.json` (Recommended):** Stores instance configuration settings applied via the admin panel. Contains sensitive data; ensure backup storage is secure.
*   **`rsa_key*` files (Recommended):** The private (`.pem`) and public (`.pub.der`) keys used for signing user authentication tokens (JWTs). The private key is sensitive; ensure backup storage is secure.
*   **`vaultwarden-db-backup.dump` (Included):** The temporary, compressed PostgreSQL database dump file created by the `pg_dump` task. This is included in the Kopia snapshot as per the desired strategy.

**Ignored Files:**
To optimize the snapshot and avoid potential issues, the following files and directories within the source path are excluded using Kopia ignore rules:

*   **`/postgres`:** This rule aims to prevent Kopia from attempting to snapshot the live PostgreSQL data volume if the source path were ever misconfigured to include it (e.g., if `/path/to/vaultwarden/data` contained a subdirectory or mount point named `postgres` pointing to the live database volume). The database itself is backed up via the `pg_dump` process.
*   **`icon_cache/`:** Caches website icons fetched for vault items. This data can be regenerated by Vaultwarden after a restore.
*   **`tmp/`:** Any temporary directories or files potentially created within the data directory.

**Example Kopia Ignore Rules:**
Based on the above, the following rules should be added to the Kopia policy for the Vaultwarden source path:

```
# Ignore the potential live postgresql data directory if present in source
/postgres

# Ignore the website icon cache directory
/data/icon_cache/

# Ignore any temporary directory
/data/tmp/
```

## References

*   **Vaultwarden Backup Wiki:** [https://github.com/dani-garcia/vaultwarden/wiki/Backing-up-your-vault](https://github.com/dani-garcia/vaultwarden/wiki/Backing-up-your-vault) - Official documentation on essential files/folders for backup.
*   **Kopia Ignore Rules:** [https://kopia.io/docs/advanced/kopiaignore/](https://kopia.io/docs/advanced/kopiaignore/) - Documentation on Kopia's file/folder exclusion syntax and patterns.
