---
- name: Check available updates and manage unattended-upgrades on Ubuntu servers
  hosts: ubuntu_servers
  become: true
  tasks:
    - name: Check unattended-upgrades service status
      ansible.builtin.service_facts:
      register: service_facts

    - name: Stop and disable unattended-upgrades service
      ansible.builtin.service:
        name: unattended-upgrades
        state: stopped
        enabled: false
      when: "'unattended-upgrades.service' in service_facts.ansible_facts.services"

    - name: Check if unattended-upgrades package is installed
      ansible.builtin.package_facts:
        manager: apt
      register: pkg_facts

    - name: Remove unattended-upgrades package
      ansible.builtin.apt:
        name: 
          - unattended-upgrades
          - update-notifier-common
        state: absent
        purge: true
      when: "'unattended-upgrades' in ansible_facts.packages"
      register: remove_output

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Get list of upgradable packages
      ansible.builtin.command: apt list --upgradable
      register: upgradable_packages
      changed_when: false

    - name: Display check summary
      vars:
        msg: |
          System Update Status:
          {% if remove_output.changed %}
          - Unattended-upgrades has been removed
          {% endif %}
          {% if upgradable_packages.stdout_lines | length > 1 %}
          - Available Updates:
            {% for pkg in upgradable_packages.stdout_lines[1:] %}
            - {{ pkg }}
            {% endfor %}
          {% else %}
          - No updates available
          {% endif %}
      ansible.builtin.debug:
        msg: "{{ msg.split('\n') }}"