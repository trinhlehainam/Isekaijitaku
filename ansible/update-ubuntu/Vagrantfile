# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # Define two Ubuntu test machines
  (1..2).each do |i|
    config.vm.define "ubuntu#{i}" do |node|
      node.vm.box = "ubuntu/jammy64"
      node.vm.hostname = "ubuntu#{i}"
      node.vm.network "private_network", ip: "192.168.56.#{10+i}"

      # Minimal VM specifications for testing
      node.vm.provider "virtualbox" do |vb|
        vb.memory = "512"
        vb.cpus = 1
        # Disable GUI and audio to save resources
        vb.gui = false
        vb.customize ["modifyvm", :id, "--audio", "none"]
        # Limit CPU execution
        vb.customize ["modifyvm", :id, "--cpuexecutioncap", "50"]
      end

      # Create different test users for SSH
      node.vm.provision "shell", inline: <<-SHELL
        useradd -m -s /bin/bash ansible#{i}
        echo "ansible#{i}:password#{i}" | chpasswd
        echo "ansible#{i} ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/ansible#{i}
        mkdir -p /home/ansible#{i}/.ssh
        chmod 700 /home/ansible#{i}/.ssh
        chown -R ansible#{i}:ansible#{i} /home/ansible#{i}/.ssh
      SHELL
    end
  end
end
