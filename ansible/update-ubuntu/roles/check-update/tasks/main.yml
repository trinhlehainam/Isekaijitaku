---
- name: Check unattended-upgrades service status
  ansible.builtin.service_facts:

- name: Stop and disable unattended-upgrades service
  ansible.builtin.service:
    name: unattended-upgrades
    state: stopped
    enabled: false
  when: "'unattended-upgrades.service' in ansible_facts.services"

- name: Check if unattended-upgrades package is installed
  ansible.builtin.package_facts:
    manager: apt

- name: Remove unattended-upgrades package
  ansible.builtin.apt:
    name: unattended-upgrades
    state: absent
    purge: true
  when: "'unattended-upgrades' in ansible_facts.packages"
  register: remove_output

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Check for available updates
  ansible.builtin.shell: apt list --upgradable
  register: upgradable_packages
  changed_when: false

- name: Display check summary
  vars:
    msg: |
      Check Update Status:
      {% if remove_output.changed %}
      - Unattended-upgrades has been removed
      {% endif %}
      {% if upgradable_packages.stdout_lines | length > 1 %}
      - Available Updates:
        {% for pkg in upgradable_packages.stdout_lines[1:] %}
        - {{ pkg }}
        {% endfor %}
      {% else %}
      - No updates available
      {% endif %}
  ansible.builtin.debug:
    msg: "{{ msg.split('\n') }}"
