# https://oauth2-proxy.github.io/oauth2-proxy/configuration/integration/#configuring-for-use-with-the-traefik-v2-forwardauth-middleware
# https://doc.traefik.io/traefik/middlewares/http/headers/
# https://doc.traefik.io/traefik/middlewares/http/forwardauth/
# https://oauth2-proxy.github.io/oauth2-proxy/features/endpoints/

# NOTE: oauth2-proxy forward auth with allowed_groups issues
# https://github.com/oauth2-proxy/oauth2-proxy/issues/1639#issuecomment-1686259034
# https://github.com/oauth2-proxy/oauth2-proxy/issues/1297#issuecomment-2004788570
# https://github.com/oauth2-proxy/oauth2-proxy/issues/334#issuecomment-2140990014

# NOTE: Keycloak logout
# https://developers.redhat.com/articles/2022/12/07/how-implement-single-sign-out-keycloak-spring-boot#back_channel_vs__front_channel_logout
# https://github.com/oauth2-proxy/oauth2-proxy/issues/1958#issuecomment-1373530220

http:
  routers:
    oauth2-proxy-local:
      # rule: "Host(`oauth2-proxy.yourdomain.local`) && PathPrefix(`/oauth2/`)"
      rule: "Host(`oauth2-proxy.yourdomain.local`)"
      service: oauth2-proxy
      tls:
        certResolver: stepca
      middlewares:
        - security-auth-headers

  services:
    oauth2-proxy:
      loadBalancer:
        servers:
          - url: "http://oauth2-proxy:4180"

  middlewares:
    # Security headers for all authenticated requests
    security-auth-headers:
      headers:
        browserXssFilter: true
        contentTypeNosniff: true
        frameDeny: true
        sslRedirect: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 315360000
        contentSecurityPolicy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:;"
        customResponseHeaders:
          X-Frame-Options: "DENY"
          X-Content-Type-Options: "nosniff"
          X-XSS-Protection: "1; mode=block"
          Referrer-Policy: "strict-origin-when-cross-origin"
          Permissions-Policy: "camera=(), microphone=(), geolocation=(), payment=()"

    # Basic authentication headers
    basic-auth-headers:
      headers:
        sslRedirect: true
        stsSeconds: 315360000
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        frameDeny: true

    # OAuth2 Proxy Forward Auth
    oauth2:
      forwardAuth:
        address: http://oauth2-proxy:4180
        trustForwardHeader: true

    # Error handling - redirect to OAuth2 sign in
    oauth2-errors:
      errors:
        status:
          - "401-403"
        service: oauth2-proxy
        query: "/oauth2/sign_in?rd={url}"

    # Group: /admin (Administrator access)
    # Note: This is a group path, distinct from the 'admin' role
    oauth2-admin:
      forwardAuth:
        address: http://oauth2-proxy:4180/oauth2/auth?allowed_groups=/admin
        trustForwardHeader: true

    # Group: /developer (Developer access)
    # Note: Includes /admin access
    # Distinct from the 'developer' role
    oauth2-developer:
      forwardAuth:
        address: http://oauth2-proxy:4180/oauth2/auth?allowed_groups=/developer,/admin
        trustForwardHeader: true

    # Group: /family (Family member access)
    # Note: Includes /developer and /admin access
    # Distinct from any roles with similar names
    oauth2-family:
      forwardAuth:
        address: http://oauth2-proxy:4180/oauth2/auth?allowed_groups=/family,/developer,/admin
        trustForwardHeader: true

    # Group: /guest (Guest access)
    # Note: Includes /family, /developer, and /admin access
    # Distinct from any roles with similar names
    oauth2-guest:
      forwardAuth:
        address: http://oauth2-proxy:4180/oauth2/auth?allowed_groups=/guest,/family,/developer,/admin
        trustForwardHeader: true
