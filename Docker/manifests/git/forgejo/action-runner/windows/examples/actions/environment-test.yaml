name: Windows Runner Environment Test
on: 
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

jobs:
  test-environment:
    runs-on: windows
    
    steps:
      - name: System Information
        run: |
          systeminfo | Select-String "OS Name", "OS Version", "System Type"
          Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)"
          $cpuInfo = Get-CimInstance Win32_Processor
          Write-Host "CPU Name: $($cpuInfo.Name)"
          Write-Host "CPU Architecture: $($cpuInfo.Architecture)"
          Write-Host "Number of CPUs: $($cpuInfo.NumberOfCores)"
          Write-Host "Number of Logical CPUs: $($cpuInfo.NumberOfLogicalProcessors)"
          Write-Host "Available RAM: $((Get-CimInstance Win32_PhysicalMemory | Measure-Object -Property capacity -Sum).sum /1gb)GB"
          # Check PowerShell version
          Write-Host "`nPowerShell Version:" -ForegroundColor Yellow
          $PSVersionTable | Format-List

      - name: Test Disk Space
        run: |
          Get-Volume | Where-Object { $_.DriveLetter } | 
          Format-Table -AutoSize DriveLetter, FileSystemLabel, 
          @{Name='Size(GB)';Expression={[math]::Round($_.Size/1GB,2)}}, 
          @{Name='FreeSpace(GB)';Expression={[math]::Round($_.SizeRemaining/1GB,2)}}
          
      - name: Test Environment Variables
        run: |
          $envVars = @(
              'UNITY_EDITOR',
              'RUSTUP_HOME',
              'CARGO_HOME',
              'NODE_EXTRA_CA_CERTS',
              'RUNNER_TEMP',
              'RUNNER_TOOL_CACHE'
          )
          
          foreach ($var in $envVars) {
              $value = [Environment]::GetEnvironmentVariable($var)
              Write-Host "${var}: $value"
          }
          
      - name: Test ImageHelpers Module Functions
        run: |
          Write-Host "Testing ImageHelpers Module Functions..."
          
          function Test-ImageHelpers {
              try {
                  Write-Host "`nTesting ImageHelpers Functions:"
                  
                  $testUrl = "https://raw.githubusercontent.com/actions/runner-images/main/README.md"
                  $testPath = Join-Path $env:TEMP "test-download.txt"
                  
                  Write-Host "Testing Invoke-DownloadWithRetry..."
                  Invoke-DownloadWithRetry -Url $testUrl -Path $testPath
                  if (Test-Path $testPath) {
                      Write-Host "[OK] Invoke-DownloadWithRetry"
                      Remove-Item $testPath -Force
                  }
                  
                  $jqPath = Join-Path $env:TEMP "jq.exe"
                  Invoke-DownloadWithRetry -Url "https://github.com/stedolan/jq/releases/download/jq-1.6/jq-win64.exe" -Path $jqPath
                  if (Test-Path $jqPath) {
                      Test-FileChecksum -Path $jqPath -ExpectedSHA256Sum "a51d36968dcbdeabb3142c6f5cf9b401a65dc3a095f3144bd0c118d5bb192753"
                      Write-Host "[OK] Test-FileChecksum"
                      Remove-Item $jqPath -Force
                  }
                  
                  Update-Environment
                  Write-Host "[OK] Update-Environment"
                  return $true
              }
              catch {
                  Write-Error -Message "ImageHelpers test failed: $_"
                  return $false
              }
          }

          function Test-UnityHelpers {
              try {
                  Write-Host "`nTesting UnityInstallHelpers Functions:"
                  
                  $unityVersions = Get-InstalledUnityEditorVersions
                  if (-not $unityVersions -or $unityVersions.Count -eq 0) {
                      Write-Host "[FAILED] Get-InstalledUnityEditorVersions: $unityVersions"
                      return $false
                  }
                  
                  foreach ($unityVersion in $unityVersions) {
                      Write-Host "[OK] Get-InstalledUnityEditorVersions: $unityVersion"
                      $changeSet = Get-UnityChangeSet -Version $unityVersion
                      if ($changeSet) {
                          Write-Host "[OK] Get-UnityChangeSet: $changeSet"
                      }
                      $editorPath = Get-UnityEditorPath -Version $unityVersion
                      if ($editorPath) {
                          Write-Host "[OK] Get-UnityEditorPath: $editorPath"
                      }
                  }
                  
                  return $true
              }
              catch {
                  Write-Error -Message "UnityHelpers test failed: $_"
                  return $false
              }
          }

          function Test-VSHelpers {
              try {
                  Write-Host "`nTesting VisualStudioHelpers Functions:"
                  
                  $vsInstance = (Get-VisualStudioBuildToolsInstances -Version 17 | Select-Object -First 1)
                  if ($vsInstance) {
                      Write-Host "[OK] Get-VisualStudioBuildToolsInstances"
                      Write-Host "Found VS instance: $vsInstance"
                  }
                  
                  $packageIds = Get-VisualStudioInstancePackageIds -Instance $vsInstance
                  if ($packageIds) {
                      Write-Host "[OK] Get-VisualStudioInstancePackageIds"
                      Write-Host "Found package IDs:"
                      Write-Host ("{0}" -f ($packageIds -join "`n"))
                  }
                  
                  return $true
              }
              catch {
                  Write-Error -Message "VSHelpers test failed: $_"
                  return $false
              }
          }

          # Run all tests
          $testResults = @(
              Test-ImageHelpers
              Test-UnityHelpers
              Test-VSHelpers
          )

          # Check if any test failed
          if ($testResults -contains $false) {
              Write-Error "One or more tests failed"
              exit 1
          }
          
      - name: Test Visual Studio Environment
        run: |
          Write-Host "Visual Studio Installation:"
          Get-VSSetupInstance
          
          Write-Host "`nMSBuild Version:"
          msbuild -version
          
          Write-Host "`nInstalled Workloads:"
          (Get-VSSetupInstance | Select-VSSetupInstance -Product *).Packages | Select-Object -ExpandProperty "Id"
          
      - name: Test .NET Environment
        run: |
          Write-Host ".NET SDKs:"
          dotnet --list-sdks
          
          Write-Host "`n.NET Runtimes:"
          dotnet --list-runtimes
          
      - name: Test Unity Environment
        run: |
          $unityHubPath = Get-UnityHubPath
          if ($unityHubPath) {
              Write-Host "Unity Hub found at: $unityHubPath"
          } else {
              Write-Error "Unity Hub not found!"
              exit 1
          }
          
          $installedUnityEditorVersions = Get-InstalledUnityEditorVersions
          if (-not $installedUnityEditorVersions -or $installedUnityEditorVersions.Count -eq 0) {
              Write-Error "Unity Editor not found!"
              exit 1
          }

          foreach ($version in $installedUnityEditorVersions) {
              Write-Host "Unity Editor Version: $version"
              $editorPath = Get-UnityEditorPath -Version $version
              if ($editorPath) {
                  Write-Host "Editor Path: $editorPath"
              }
          }
          
      - name: Test Node.js Environment
        run: |
          Write-Host "Node.js Version:"
          node --version
          
          Write-Host "`nnpm Version:"
          npm --version
          
          Write-Host "`nGlobal npm packages:"
          npm list -g --depth=0
          
      - name: Test Rust Environment
        run: |
          Write-Host "Setting up Rust environment..."
          
          # Check if rustup is installed
          if (-not (Get-Command rustup -ErrorAction SilentlyContinue)) {
              Write-Error "rustup is not installed. Please install Rust toolchain first."
              exit 1
          }
          
          # Install and set default toolchain if not configured
          $defaultToolchain = rustup default
          if ($LASTEXITCODE -ne 0) {
              Write-Host "No default toolchain found. Installing stable toolchain..."
              rustup toolchain install stable
              rustup default stable
              
              # Verify installation
              $defaultToolchain = rustup default
              if ($LASTEXITCODE -ne 0) {
                  Write-Error "Failed to set up default toolchain"
                  exit 1
              }
          }
          Write-Host "Default toolchain: $defaultToolchain"
          
          Write-Host "`nRust Version:"
          rustc --version
          
          Write-Host "`nCargo Version:"
          cargo --version
          
          Write-Host "`nInstalled Components:"
          rustup component list --installed
          
          Write-Host "`nInstalled Targets:"
          $installedTargets = @(rustup target list --installed)
          Write-Host $installedTargets
          
          Write-Host "`nAvailable Targets:"
          $allTargets = @(rustup target list)
          Write-Host $allTargets
          
          # Ensure required targets are installed
          $requiredTargets = @(
              "x86_64-pc-windows-msvc",
              "i686-pc-windows-msvc"
          )
          
          foreach ($target in $requiredTargets) {
              if ($installedTargets -notcontains $target) {
                  Write-Host "`nInstalling target: $target"
                  rustup target add $target
                  if ($LASTEXITCODE -eq 0) {
                      $installedTargets += $target
                  } else {
                      Write-Warning "Failed to install target: $target"
                  }
              }
          }

      - name: Test Build Tools
        run: |
          Write-Host "Chocolatey Version:"
          choco --version
          
          Write-Host "`nGit Version:"
          git --version
          
          Write-Host "`nCMake Version:"
          cmake --version
          
          Write-Host "`nNinja Version:"
          ninja --version
          
      - name: Test Python Prerequisites
        run: |
          Write-Host "Testing Python Prerequisites..." -ForegroundColor Cyan

          # Check execution policies
          Write-Host "`nPowerShell Execution Policies:" -ForegroundColor Yellow
          Get-ExecutionPolicy -List | Format-Table -AutoSize

          # Check 7-Zip installation
          Write-Host "`n7-Zip Installation:" -ForegroundColor Yellow
          $7zPath = (Get-Command "7z.exe" -ErrorAction SilentlyContinue).Path
          if ($7zPath) {
              Write-Host "7-Zip found at: $7zPath"
              & 7z.exe i
          } else {
              Write-Host "7-Zip not found in PATH!" -ForegroundColor Red
              exit 1
          }

          # Check running as administrator/service account
          Write-Host "`nCurrent User Context:" -ForegroundColor Yellow
          $currentUser = [Security.Principal.WindowsIdentity]::GetCurrent()
          $currentPrincipal = New-Object Security.Principal.WindowsPrincipal($currentUser)
          
          Write-Host "Current user: $($currentUser.Name)"
          Write-Host "Is Administrator: $($currentPrincipal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator))"
          Write-Host "Is System Account: $($currentUser.User.Value -eq 'S-1-5-18')"
          Write-Host "Is Network Service: $($currentUser.User.Value -eq 'S-1-5-20')"

          # List groups
          Write-Host "`nUser Groups:"
          $currentUser.Groups | ForEach-Object {
              try {
                  $group = $_.Translate([Security.Principal.NTAccount])
                  Write-Host " - $($group.Value)"
              } catch {
                  Write-Host " - $($_.Value) (SID)"
              }
          }

      - name: Generate Environment Report
        run: |
          $report = @{
              Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
              OS = (Get-CimInstance Win32_OperatingSystem).Caption
              PowerShell = $PSVersionTable.PSVersion.ToString()
              DotNet = (dotnet --version)
              Node = (node --version)
              Rust = (rustc --version)
              Unity = Get-UnityEditorPath -Version "2019.4.24f1"
              VisualStudio = (Get-VSSetupInstance | ForEach-Object { $_.DisplayName }) -join ", "
              ImageHelpersModules = @{
                  ModuleVersion = (Get-Module ImageHelpers).Version.ToString()
                  Functions = @(Get-Command -Module ImageHelpers | Select-Object -ExpandProperty Name)
              }
          }
          
          $report | ConvertTo-Json -Depth 10 | Out-File environment-report.json
          
      - name: Upload Environment Report
        uses: actions/upload-artifact@v3
        with:
          name: environment-report
          path: environment-report.json
