# References:
# - Gitea Runner: https://gitea.com/gitea/act_runner
# - Docker Compose Example: https://gitea.com/gitea/act_runner/src/branch/main/examples/docker-compose
# - GameCI Windows Docker Images: https://game.ci/docs/docker/windows-docker-images

services:
  gitea-runner:
    build:
      context: .
      dockerfile: Dockerfile
      # args:
      #   GITEA_RUNNER_VERSION: 0.2.11
      #   WINDOWS_IMAGE: your-registry/your-custom-windows-image:latest
    environment:
      - GITEA_INSTANCE_URL=https://your-forgejo-instance-url
      # When using Docker Secrets, it's also possible to use
      # GITEA_RUNNER_REGISTRATION_TOKEN_FILE to pass the location.
      # The env var takes precedence.
      # Needed only for the first start.
      - GITEA_RUNNER_REGISTRATION_TOKEN=your-runner-token
      # OR use token file (e.g., Docker Secret)
      # - GITEA_RUNNER_REGISTRATION_TOKEN_FILE=/run/secrets/runner-token
      - GITEA_RUNNER_NAME=windows-container-gitea-runner
      - GITEA_RUNNER_LABELS=windows:host
      - EXTRA_CERT_FILES=C:\certs\root.crt,C:\certs\intermediate.crt,C:\all-certs
    volumes:
      # Mount runner data directory for persistence
      - ./runner:/data
      # Optional: Mount Visual Studio tools if needed
      # - "C:\\Program Files (x86)\\Windows Kits:C:\\Program Files (x86)\\Windows Kits"
      # - "C:\\Program Files (x86)\\Microsoft Visual Studio:C:\\Program Files (x86)\\Microsoft Visual Studio"
      # - "C:\\Program Files\\Microsoft Visual Studio:C:\\Program Files\\Microsoft Visual Studio"
      # - "C:\\ProgramData\\Microsoft\\VisualStudio:C:\\ProgramData\\Microsoft\\VisualStudio"
      - ./certs/root.crt:C:\certs\root.crt:ro
      - ./certs/intermediate.crt:C:\certs\intermediate.crt:ro
      - ./all-certs:C:\all-certs:ro
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
    networks:
      - gitea_network
    restart: unless-stopped

networks:
  gitea_network:
    external: true