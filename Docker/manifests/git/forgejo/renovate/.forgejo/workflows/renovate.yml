name: Renovate
on:
  # Schedule Renovate to run on a regular basis
  schedule:
    - cron: "0 * * * *"  # Run every hour
  # Allow manual trigger
  workflow_dispatch:
  # Also run on changes to configuration files
  push:
    branches:
      - main

env:
  LOG_FILE: renovate-log.ndjson
  
jobs:
  renovate:
    name: Renovate
    runs-on: ubuntu-latest
    # Use container-based execution like the official Gitea repo
    # https://github.com/renovatebot/renovate/pkgs/container/renovate
    container: ghcr.io/renovatebot/renovate:39.233.5
    
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: Restore Renovate repository cache
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: renovate/cache/renovate/repository
          key: v1-renovate-repo-${{ hashFiles('**/config.js') }}
          restore-keys: v1-renovate-repo-

      - name: Run Renovate
        run: renovate
        env:
          LOG_LEVEL: "debug"
          RENOVATE_CONFIG_FILE: "${{ github.workspace }}/config.js"
          RENOVATE_CONFIG_MIGRATION: "true"
          # Repository and file caching
          RENOVATE_BASE_DIR: "${{ github.workspace }}/renovate"
          RENOVATE_REPOSITORY_CACHE: "enabled"
          # Log file for artifact upload
          LOG_FILE: "${{ env.LOG_FILE }}"
          LOG_FILE_LEVEL: "debug"
          # Required credentials
          # Forgejo Personal Access Token for Forgejo API access
          RENOVATE_TOKEN: ${{ secrets.RENOVATE_TOKEN }}
          # GitHub.com token for fetching changelogs and bypassing API rate limits
          RENOVATE_GITHUB_COM_TOKEN: ${{ secrets.RENOVATE_GITHUB_COM_TOKEN || '' }}
          # Docker Hub credentials for higher rate limits
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME || '' }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD || '' }}
      
      - name: Upload Renovate logs
        uses: actions/upload-artifact@ff15f0306b3f739f7b6fd43fb5d26cd321bd4de5 # v3.2.1
        env:
          # When custom certificates are installed to the system store,
          # Node.js used by actions doesn't automatically detect them,
          # so we need to explicitly point to the certificate bundle
          NODE_EXTRA_CA_CERTS: /etc/ssl/certs/ca-certificates.crt
        if: always()
        with:
          name: renovate-logs
          path: ${{ env.LOG_FILE }}
          retention-days: 1