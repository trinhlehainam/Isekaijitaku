name: Renovate
on:
  # Schedule Renovate to run on a regular basis
  schedule:
    - cron: "0 * * * *"  # Run every hour
  # Allow manual trigger
  workflow_dispatch:
  # Disabled push trigger to prevent workflow cancellation with auto-merges
  # Forgejo/Gitea Actions don't fully support concurrency
  # push:
  #   branches:
  #     - main

env:
  LOG_FILE: renovate-log.ndjson

jobs:
  renovate:
    name: Renovate
    runs-on: ubuntu-latest
    # Use container-based execution like the official Gitea repo
    # https://github.com/renovatebot/renovate/pkgs/container/renovate
    container: ghcr.io/renovatebot/renovate:39.235.2
    # Concurrency not fully supported in Forgejo/Gitea yet
    # concurrency:
    #   group: ${{ github.workflow }}-${{ github.ref }}
    #   cancel-in-progress: false

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: Restore Renovate repository cache
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: renovate/cache/renovate/repository
          key: renovate-repo

      - name: Run Renovate
        run: renovate
        env:
          LOG_LEVEL: "debug"
          RENOVATE_CONFIG_FILE: "${{ github.workspace }}/config.js"
          RENOVATE_CONFIG_MIGRATION: "true"
          # Repository and file caching
          RENOVATE_BASE_DIR: "${{ github.workspace }}/renovate"
          RENOVATE_REPOSITORY_CACHE: "enabled"
          # Log file for artifact upload
          LOG_FILE: "${{ env.LOG_FILE }}"
          LOG_FILE_LEVEL: "debug"
          # Required credentials
          # Forgejo Personal Access Token for Forgejo API access
          RENOVATE_TOKEN: ${{ secrets.RENOVATE_TOKEN }}
          # GitHub.com token for fetching changelogs and bypassing API rate limits
          RENOVATE_GITHUB_COM_TOKEN: ${{ secrets.RENOVATE_GITHUB_COM_TOKEN || '' }}
          # Docker Hub credentials for higher rate limits
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME || '' }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD || '' }}
      
      - name: Upload Renovate logs
        uses: https://code.forgejo.org/forgejo/upload-artifact@16871d9e8cfcf27ff31822cac382bbb5450f1e1e # v4.3.1
        env:
          # When custom certificates are installed to the system store,
          # Node.js used by actions doesn't automatically detect them,
          # so we need to explicitly point to the certificate bundle
          NODE_EXTRA_CA_CERTS: /etc/ssl/certs/ca-certificates.crt
        if: always()
        with:
          name: renovate-logs
          path: ${{ env.LOG_FILE }}
          retention-days: 1