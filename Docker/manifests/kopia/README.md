# Kopia Docker Compose Configuration

This document outlines the configuration and operational details for running Kopia using the provided `docker-compose.yml` file.

## Important Limitation: Single Repository Only

Kopia server does not currently support serving multiple repositories from a single server instance. Each Kopia server can only be connected to a single repository at a time. For more details and ongoing discussion, see the upstream issue: [kopia/kopia#2976](https://github.com/kopia/kopia/issues/2976).

## Prerequisites

Ensure Docker and Docker Compose are installed. Create the following secret files in a `./secrets` subdirectory relative to the `docker-compose.yml`:

*   `kopia_username`: Desired username for accessing the Kopia Web UI.
*   `kopia_password`: Password corresponding to the Kopia Web UI username.
*   `kopia_repo_password`: Password for encrypting the Kopia repository data.

## Service Configuration (`docker-compose.yml`)

The `docker-compose.yml` defines a single service named `kopia`.

### Image and Environment
The service uses the `kopia/kopia:0.19.0` image. The timezone is set to `Asia/Tokyo`. Environment variables `KOPIA_UI_USERNAME`, `KOPIA_UI_PASSWORD`, and `KOPIA_PASSWORD` are dynamically populated at container start from the corresponding Docker secrets.

### Volumes

Persistent data and configuration are managed through volume mounts:

*   `./config:/app/config`: Stores Kopia's primary configuration files.
*   `./cache:/app/cache`: Used for Kopia's caching mechanisms.
*   `./logs:/app/logs`: Contains operational logs generated by Kopia.
*   `/:/data:ro`: Mounts the host's entire root filesystem read-only into `/data` inside the container. This allows Kopia to read files for backup operations across the host system.
*   `./repository:/repository`: (Optional) Designated location for storing the actual backup data if using a local filesystem repository.
*   `/tmp:/tmp:shared`: Mounts the host's `/tmp` directory. The `:shared` propagation is essential for browsing snapshots using FUSE mounts. When Kopia mounts a snapshot (e.g., via the Web UI or CLI `kopia mount` command) inside the container's `/tmp`, this propagation makes the mount point directly accessible on the host system at `/tmp`.

### FUSE Mounting for Snapshot Browsing

To enable browsing of snapshot contents directly via the filesystem, Kopia utilizes FUSE. This requires specific container capabilities and device access:

*   `cap_add: SYS_ADMIN`: Grants the necessary system administration capabilities for FUSE operations.
*   `devices: /dev/fuse:/dev/fuse:rwm`: Provides the container with read-write access to the host's FUSE device.

Without these settings, mounting snapshots for browsing will fail.

### Networking and Access

The Kopia container is connected to an external Docker network named `proxy`. It does not expose port `51515` directly. Instead, access is managed via Traefik reverse proxy, configured through labels:

*   Traefik is enabled for the service.
*   The service load balancer points to the container's port `51515`.
*   A router named `kopia-local` directs traffic for the host `kopia.yourdomain.local` (adjust as needed) to this service via the `websecure` entrypoint (typically HTTPS).
*   TLS certificate resolution is handled by the `stepca` resolver (configure Traefik accordingly).

## Operational Notes (v0.19.0)

### Snapshot Synchronization Delay (CLI vs. UI)

In Kopia version `0.19.0`, snapshots created using the Kopia command-line interface (`kopia snapshot create ...`) may not immediately appear in the Web UI's snapshot list (`/snapshots`). A noticeable delay can occur.

To force the Web UI to refresh and display newly created CLI snapshots, navigate to the Snapshots page in the UI and click the synchronize (circular arrows/reload) icon. This action triggers a refresh of the snapshot list from the repository, making the CLI-created snapshots visible.

### Executing CLI Commands Inside the Container

To run Kopia CLI commands directly, execute them inside the running container using `docker compose exec`:

```bash
docker compose exec -it kopia kopia <command> [options]
```

For example, to create a snapshot of a directory located at `/home/user/important-data` on the host machine, you need to reference its path within the container. Since the host's root (`/`) is mounted read-only at `/data` inside the container, the corresponding path is `/data/home/user/important-data`:

```bash
docker compose exec -it kopia kopia snapshot create /data/home/user/important-data
```

Remember to always prefix the host path with `/data` when specifying source directories for Kopia commands executed inside the container.

## Deployment

Start the service using Docker Compose:

```bash
docker compose up -d
```

Access the Web UI via the hostname configured in the Traefik labels (e.g., `https://kopia.yourdomain.local`).

## References

*   [Kopia CLI Command Reference](https://kopia.io/docs/reference/command-line/common/)
*   [Kopia Docker Installation](https://kopia.io/docs/installation/#docker-images)
*   [Kopia Docker Compose](https://github.com/kopia/kopia/blob/master/tools/docker/docker-compose.yml)